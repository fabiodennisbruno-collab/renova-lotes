<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Renova Lotes ‚Äì CRM Premium</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/crm-premium.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    /* ‚îÄ‚îÄ Base Layout ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      min-height: 100%;
      background: var(--crm-bg);
      color: var(--crm-text);
      font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
      font-size: 14px;
      line-height: 1.5;
    }
    #app { display: flex; flex-direction: column; min-height: 100vh; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 20px;
      border-bottom: 1px solid var(--crm-border);
      background: rgba(11,15,26,.92);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
    }
    .app-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: -.3px;
      background: var(--crm-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
    }
    .app-logo span { font-size: 22px; -webkit-text-fill-color: initial; }
    .header-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    /* ‚îÄ‚îÄ Sync Status Bar ‚îÄ‚îÄ */
    .sync-status-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--crm-surface);
      border: 1px solid var(--crm-border);
      font-size: 12px;
      cursor: pointer;
      transition: background var(--crm-transition);
    }
    .sync-status-bar:hover { background: rgba(255,255,255,.09); }
    .sync-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #6b7280;
      transition: background .3s;
    }
    .sync-dot.online  { background: #10B981; box-shadow: 0 0 5px rgba(16,185,129,.6); }
    .sync-dot.offline { background: #EF4444; box-shadow: 0 0 5px rgba(239,68,68,.6); }
    .sync-dot.syncing { background: #F59E0B; animation: syncPulse 1s infinite; }
    @keyframes syncPulse { 0%,100%{opacity:1} 50%{opacity:.4} }

    /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
    .tabs {
      display: grid;
      gap: 0;
      border-bottom: 1px solid var(--crm-border);
      background: rgba(11,15,26,.7);
      padding: 0 20px;
      overflow-x: auto;
    }
    .tab {
      padding: 12px 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--crm-muted);
      border: none;
      background: transparent;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all var(--crm-transition);
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .tab:hover  { color: var(--crm-text); }
    .tab.active { color: var(--crm-primary); border-bottom-color: var(--crm-primary); }

    /* ‚îÄ‚îÄ Tab Panels ‚îÄ‚îÄ */
    .tab-panel { display: none; padding: 20px; animation: fadeInUp .25s ease both; }
    .tab-panel.active { display: block; }

    /* ‚îÄ‚îÄ Sync Dashboard Panel ‚îÄ‚îÄ */
    .sync-dashboard {
      display: none;
      position: fixed;
      top: 64px;
      right: 16px;
      width: 300px;
      background: rgba(14,18,30,.97);
      border: 1px solid var(--crm-border);
      border-radius: var(--crm-radius);
      box-shadow: var(--crm-shadow);
      backdrop-filter: blur(20px);
      z-index: 300;
      padding: 16px;
      animation: fadeInUp .2s ease;
    }
    .sync-dashboard.open { display: block; }
    .sync-dash-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .sync-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 7px 0;
      border-bottom: 1px solid rgba(255,255,255,.05);
      font-size: 12px;
    }
    .sync-metric:last-child { border-bottom: none; }
    .sync-metric-label { color: var(--crm-muted); }
    .sync-metric-val   { font-weight: 700; }

    /* ‚îÄ‚îÄ Auth Modal ‚îÄ‚îÄ */
    #authModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.70);
      display: none;
      place-items: center;
      padding: 20px;
      z-index: 400;
      backdrop-filter: blur(6px);
    }
    #authModal.open { display: grid; }
    .auth-box {
      width: min(400px, 100%);
      background: rgba(14,18,30,.98);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: var(--crm-shadow);
      overflow: hidden;
      animation: crmModalIn .22s cubic-bezier(.4,0,.2,1);
    }
    .auth-head {
      padding: 20px 22px 16px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      text-align: center;
    }
    .auth-head h2 { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
    .auth-head p  { font-size: 12px; color: var(--crm-muted); }
    .auth-body { padding: 20px 22px; display: flex; flex-direction: column; gap: 12px; }
    .auth-field { display: flex; flex-direction: column; gap: 5px; }
    .auth-field label { font-size: 11px; color: var(--crm-muted); text-transform: uppercase; letter-spacing: .5px; }
    .auth-field input {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.30);
      color: var(--crm-text);
      font-size: 13px;
      outline: none;
      transition: border-color var(--crm-transition), box-shadow var(--crm-transition);
    }
    .auth-field input:focus {
      border-color: rgba(108,99,255,.55);
      box-shadow: 0 0 0 3px rgba(108,99,255,.15);
    }
    .auth-msg {
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      display: none;
    }
    .auth-msg.error   { background: rgba(239,68,68,.15); border: 1px solid rgba(239,68,68,.3); color: #fca5a5; display: block; }
    .auth-msg.success { background: rgba(16,185,129,.15); border: 1px solid rgba(16,185,129,.3); color: #6ee7b7; display: block; }
    .auth-foot { padding: 14px 22px 20px; display: flex; flex-direction: column; gap: 8px; }
    .auth-toggle { font-size: 12px; text-align: center; color: var(--crm-muted); cursor: pointer; }
    .auth-toggle a { color: #a5b4fc; text-decoration: none; }
    .auth-toggle a:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ Page titles ‚îÄ‚îÄ */
    .page-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .page-title small { font-size: 12px; color: var(--crm-muted); font-weight: 400; }
  </style>
</head>

<body>
<div id="app">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <header class="app-header">
    <div class="app-logo"><span>üè†</span> Renova Lotes</div>
    <div class="header-actions">
      <button class="sync-status-bar" id="syncStatusBtn" title="Dashboard de Sincroniza√ß√£o">
        <span class="sync-dot" id="syncDot"></span>
        <span id="syncStatusTxt">Sem conex√£o</span>
        <span>‚Üª</span>
      </button>
      <button class="crm-btn sm primary" id="syncNowBtn">‚Üª Sync</button>
      <button class="crm-btn sm" id="authBtn" onclick="CloudSync.openAuthModal()">üîê Login Nuvem</button>
    </div>
  </header>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYNC DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="sync-dashboard" id="syncDashboard">
    <div class="sync-dash-title">
      ‚òÅÔ∏è Cloud Sync v2
      <button class="crm-btn sm" onclick="document.getElementById('syncDashboard').classList.remove('open')" style="padding:4px 8px;font-size:11px;">‚úï</button>
    </div>
    <div class="sync-metric"><span class="sync-metric-label">üì° Status</span><span class="sync-metric-val" id="dashNetStatus">‚Äî</span></div>
    <div class="sync-metric"><span class="sync-metric-label">üë§ Usu√°rio</span><span class="sync-metric-val" id="dashUser">N√£o autenticado</span></div>
    <div class="sync-metric"><span class="sync-metric-label">‚¨ÜÔ∏è Enviados</span><span class="sync-metric-val" id="dashSent">0</span></div>
    <div class="sync-metric"><span class="sync-metric-label">‚¨áÔ∏è Recebidos</span><span class="sync-metric-val" id="dashReceived">0</span></div>
    <div class="sync-metric"><span class="sync-metric-label">üîÑ Fila pendente</span><span class="sync-metric-val" id="dashQueue">0</span></div>
    <div class="sync-metric"><span class="sync-metric-label">üïê √öltimo sync</span><span class="sync-metric-val" id="dashLastSync">‚Äî</span></div>
    <div style="margin-top:12px;display:flex;gap:8px;">
      <button class="crm-btn sm primary" style="flex:1" onclick="CloudSync.syncNow()">‚Üª Sincronizar</button>
      <button class="crm-btn sm danger" style="flex:1" id="logoutBtn" onclick="CloudSync.logout()">Sair</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <nav class="tabs" id="mainTabs">
    <button class="tab active" data-tab="dashboardCRM">üìä Dashboard</button>
    <button class="tab" data-tab="clientes">üë• Clientes</button>
    <button class="tab" data-tab="estoqueCRM">üì¶ Estoque</button>
    <button class="tab" data-tab="pdvPro">üõí PDV Pro</button>
    <button class="tab" data-tab="caixa">üí∞ Caixa</button>
  </nav>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel active" id="panel-dashboardCRM">
    <div id="dashboardCRM">
      <div class="page-title">üìä Dashboard <small>Vis√£o geral do neg√≥cio</small></div>
      <div class="crm-kpis crm-mb" id="dashKPIs"></div>
      <div class="crm-charts-grid crm-mb" id="dashPremium">
        <div class="crm-chart-wrap">
          <div class="crm-chart-title">üìà Receita por M√™s</div>
          <canvas id="chartVendasMes" data-height="200"></canvas>
        </div>
        <div class="crm-chart-wrap">
          <div class="crm-chart-title">üè∑Ô∏è Estoque por Categoria</div>
          <canvas id="chartEstoqueCategoria" data-height="200"></canvas>
        </div>
        <div class="crm-chart-wrap">
          <div class="crm-chart-title">üèÜ Top Produtos</div>
          <canvas id="chartTopProdutos" data-height="200"></canvas>
        </div>
        <div class="crm-chart-wrap">
          <div class="crm-chart-title">üë• Clientes por Categoria</div>
          <canvas id="chartClientesCat" data-height="200"></canvas>
        </div>
      </div>
      <div class="crm-charts-grid">
        <div class="crm-card">
          <div class="crm-card-head"><h3>üõí √öltimas Vendas</h3></div>
          <div class="crm-card-body crm-timeline" id="dashUltimasVendas"></div>
        </div>
        <div class="crm-card">
          <div class="crm-card-head"><h3>‚ö†Ô∏è Alerta de Estoque</h3></div>
          <div class="crm-card-body crm-timeline" id="dashProdAlerta"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: CLIENTES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="panel-clientes">
    <div class="page-title">üë• Clientes <small>Gest√£o de clientes CRM</small></div>
    <div class="crm-between crm-mb">
      <div class="crm-search" style="max-width:320px;">
        <span class="s-icon">üîç</span>
        <input type="text" id="cliSearch" placeholder="Buscar cliente‚Ä¶">
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <select id="cliFilter" style="padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:var(--crm-text);font-size:13px;outline:none;">
          <option value="">Todas categorias</option>
          <option value="VIP">VIP</option>
          <option value="Regular">Regular</option>
          <option value="Novo">Novo</option>
        </select>
        <button class="crm-btn primary" id="cliNewBtn">‚ûï Novo Cliente</button>
      </div>
    </div>
    <div class="crm-flex crm-mb" id="cliStats" style="font-size:13px;"></div>
    <div class="crm-table-wrap">
      <table class="crm-table">
        <thead>
          <tr>
            <th>Cliente</th><th>Telefone</th><th>Cidade/UF</th>
            <th>Categoria</th><th>Total Compras</th><th>√öltima Compra</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="cliTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: ESTOQUE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="panel-estoqueCRM">
    <div class="page-title">üì¶ Estoque <small>Controle de produtos</small></div>
    <div class="crm-between crm-mb">
      <div class="crm-search" style="max-width:320px;">
        <span class="s-icon">üîç</span>
        <input type="text" id="estoqueCRMSearch" placeholder="Buscar produto, SKU‚Ä¶" oninput="renderEstoqueCRM()">
      </div>
      <button class="crm-btn sm" onclick="exportProdutosPDV()">‚¨áÔ∏è Exportar CSV</button>
    </div>
    <div class="crm-table-wrap">
      <table class="crm-table">
        <thead>
          <tr>
            <th>SKU</th><th>Produto</th><th>Categoria</th><th>Local</th>
            <th>Estoque</th><th>M√≠nimo</th><th>Pre√ßo</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="estoqueCRMTb"></tbody>
      </table>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: PDV PRO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="panel-pdvPro">
    <div class="page-title">üõí PDV Pro <small>Ponto de venda</small></div>
    <div class="pdv-layout">
      <div>
        <div class="crm-between crm-mb">
          <div class="crm-search" style="flex:1;max-width:280px;">
            <span class="s-icon">üîç</span>
            <input type="text" id="pdvSearch" placeholder="Buscar produto‚Ä¶">
          </div>
          <select id="pdvCatFilter" style="padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:var(--crm-text);font-size:13px;outline:none;">
            <option value="">Todas categorias</option>
          </select>
        </div>
        <div class="pdv-product-grid" id="pdvProductGrid"></div>
        <div class="crm-card crm-mt">
          <div class="crm-card-head"><h3>üìã Hist√≥rico de Vendas</h3></div>
          <div class="crm-card-body" style="padding:0;">
            <div class="crm-table-wrap">
              <table class="crm-table">
                <thead>
                  <tr><th>Data</th><th>Cliente</th><th>Itens</th><th>Pagamento</th><th>Desconto</th><th>Total</th><th>A√ß√µes</th></tr>
                </thead>
                <tbody id="pdvHistTb"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="pdv-cart">
        <div style="font-size:15px;font-weight:800;">üõí Carrinho</div>
        <div>
          <label style="font-size:11px;color:var(--crm-muted);text-transform:uppercase;letter-spacing:.5px;">Cliente</label>
          <select id="pdvCliente" style="width:100%;margin-top:5px;padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:var(--crm-text);font-size:13px;outline:none;">
            <option value="">‚Äî Venda avulsa ‚Äî</option>
          </select>
        </div>
        <div id="pdvCartItems"></div>
        <div class="pdv-total-box">
          <div class="pdv-total-row">
            <span>Subtotal</span>
            <span id="pdvSubtotal">R$ 0,00</span>
          </div>
          <div class="pdv-total-row">
            <span>Desconto (R$)</span>
            <input type="number" id="pdvDesconto" min="0" step="0.01" value="0"
              style="width:90px;padding:5px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:var(--crm-text);font-size:13px;text-align:right;outline:none;">
          </div>
          <div class="pdv-total-row grand">
            <span>Total</span>
            <span id="pdvTotal">R$ 0,00</span>
          </div>
        </div>
        <div>
          <div style="font-size:11px;color:var(--crm-muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">Pagamento</div>
          <div class="pdv-payment-opts">
            <button class="pdv-pay-btn active" data-pag="dinheiro">üíµ Dinheiro</button>
            <button class="pdv-pay-btn" data-pag="cartao_debito">üí≥ D√©bito</button>
            <button class="pdv-pay-btn" data-pag="cartao_credito">üí≥ Cr√©dito</button>
            <button class="pdv-pay-btn" data-pag="pix">üì± PIX</button>
          </div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="crm-btn danger sm" id="pdvClearBtn" style="flex:1">üóëÔ∏è Limpar</button>
          <button class="crm-btn success" id="pdvFinalizarBtn" style="flex:2;font-size:14px;">‚úÖ Finalizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: CAIXA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="panel-caixa">
    <div class="page-title">üí∞ Caixa <small>Fluxo de caixa</small></div>
    <div class="crm-cash-header">
      <div>
        <div style="font-size:11px;color:var(--crm-muted);text-transform:uppercase;letter-spacing:.6px;">Saldo Atual</div>
        <div class="crm-cash-balance text-green" id="caixaSaldo">R$ 0,00</div>
      </div>
      <div class="crm-flex">
        <div class="crm-kpi" style="min-width:140px;">
          <div class="kpi-label">Entradas</div>
          <div class="kpi-value text-green" id="caixaEntradas">R$ 0,00</div>
        </div>
        <div class="crm-kpi" style="min-width:140px;">
          <div class="kpi-label">Sa√≠das</div>
          <div class="kpi-value text-red" id="caixaSaidas">R$ 0,00</div>
        </div>
      </div>
    </div>
    <div class="crm-card crm-mb">
      <div class="crm-card-head"><h3>‚ûï Nova Movimenta√ß√£o</h3></div>
      <div class="crm-card-body">
        <div class="crm-flex" style="flex-wrap:wrap;">
          <div class="crm-field" style="flex:2;min-width:200px;">
            <label>Descri√ß√£o</label>
            <input type="text" id="caixaNovaDesc" placeholder="Ex: Venda de sof√°‚Ä¶">
          </div>
          <div class="crm-field" style="min-width:130px;">
            <label>Valor (R$)</label>
            <input type="number" id="caixaNovaVal" min="0.01" step="0.01" placeholder="0,00">
          </div>
          <div class="crm-field" style="min-width:130px;">
            <label>Tipo</label>
            <select id="caixaNovaTipo" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:var(--crm-text);font-size:13px;outline:none;">
              <option value="entrada">Entrada</option>
              <option value="saida">Sa√≠da</option>
            </select>
          </div>
          <div class="crm-field" style="align-self:flex-end;">
            <button class="crm-btn success" onclick="caixaRegistrar()">Registrar</button>
          </div>
        </div>
      </div>
    </div>
    <div class="crm-card">
      <div class="crm-card-head"><h3>üìã Movimenta√ß√µes</h3></div>
      <div class="crm-card-body crm-timeline" id="caixaTimeline"></div>
    </div>
  </div>

</div><!-- /#app -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: CLIENTES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="crm-modal-backdrop" id="cliModalBackdrop">
  <div class="crm-modal">
    <div class="crm-modal-head">
      <h3 id="cliModalTitle">‚ûï Novo Cliente</h3>
      <button class="crm-btn sm" id="cliModalClose">‚úï</button>
    </div>
    <div class="crm-modal-body">
      <form class="crm-form" id="cliForm" onsubmit="return false;">
        <div class="crm-field">
          <label>Nome completo *</label>
          <input type="text" id="cliNome" placeholder="Nome do cliente" required>
        </div>
        <div class="crm-field">
          <label>Telefone</label>
          <input type="tel" id="cliTel" placeholder="(11) 99999-9999">
        </div>
        <div class="crm-field">
          <label>E-mail</label>
          <input type="email" id="cliEmail" placeholder="email@exemplo.com">
        </div>
        <div class="crm-field">
          <label>Cidade</label>
          <input type="text" id="cliCidade" placeholder="S√£o Paulo">
        </div>
        <div class="crm-field">
          <label>Estado (UF)</label>
          <input type="text" id="cliEstado" maxlength="2" placeholder="SP" style="text-transform:uppercase;">
        </div>
        <div class="crm-field">
          <label>Categoria</label>
          <select id="cliCategoria" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:var(--crm-text);font-size:13px;outline:none;">
            <option value="Regular">Regular</option>
            <option value="VIP">VIP</option>
            <option value="Novo">Novo</option>
          </select>
        </div>
        <div class="crm-field full">
          <label>Observa√ß√µes</label>
          <textarea id="cliObs" placeholder="Observa√ß√µes sobre o cliente‚Ä¶"></textarea>
        </div>
      </form>
    </div>
    <div class="crm-modal-foot">
      <button class="crm-btn" id="cliCancelBtn">Cancelar</button>
      <button class="crm-btn primary" id="cliSaveBtn">üíæ Salvar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL: AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="authModal">
  <div class="auth-box">
    <div class="auth-head">
      <h2>‚òÅÔ∏è Cloud Sync v2</h2>
      <p id="authModalSubtitle">Fa√ßa login para sincronizar seus dados em nuvem</p>
    </div>
    <div class="auth-body">
      <div class="auth-field">
        <label>E-mail</label>
        <input type="email" id="authEmail" placeholder="seu@email.com" autocomplete="email">
      </div>
      <div class="auth-field">
        <label>Senha (m√≠n. 6 caracteres)</label>
        <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </div>
      <div class="auth-msg" id="authMsg"></div>
    </div>
    <div class="auth-foot">
      <button class="crm-btn primary" id="authSubmitBtn" style="width:100%;justify-content:center;">üîê Entrar</button>
      <button class="crm-btn" id="authCloseBtn" style="width:100%;justify-content:center;">‚úï Cancelar</button>
      <div class="auth-toggle" id="authToggle">
        Sem conta? <a href="#" id="authSwitchLink">Criar conta agora</a>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="js/data/seed-crm.js"></script>
<script src="js/utils/charts-premium.js"></script>
<script src="js/modules/dashboard-premium.js"></script>
<script src="js/modules/clientes.js"></script>
<script src="js/modules/pdv-pro.js"></script>
<script src="js/crm-app.js"></script>

<script>
/* ================================================================
   CLOUD SYNC v2 -- Supabase Integration + Offline-First Engine
   ================================================================
   Configure your Supabase credentials below:

     window.SUPABASE_URL      = "https://seu-projeto.supabase.co";
     window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";

   Obtain values at: https://app.supabase.com/project/YOUR_ID/settings/api
   ================================================================ */

window.SUPABASE_URL      = window.SUPABASE_URL      || '';
window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';

const SYNC_TABLE       = 'cloud_items';
const SYNC_CONFLICT    = 'user_id,data_key';
const MAX_SYNC_RETRIES = 3;
const AUTO_SYNC_INTERVAL_MS = 30000;

const SYNC_KEYS = {
  queue     : 'renova_sync_queue_v2',
  timestamp : 'renova_sync_timestamp',
  authToken : 'renova_auth_token_v2',
  authUser  : 'renova_auth_user_v2',
  items     : 'renova_lotes_html_v6',
  config    : 'renova_lotes_html_v6_config',
  trash     : 'renova_lotes_html_v6_trash',
};

const CloudSync = (() => {
  let _client       = null;
  let _session      = null;
  let _isOnline     = navigator.onLine;
  let _isSyncing    = false;
  let _stats        = { sent: 0, received: 0 };
  let _syncInterval = null;
  let _authMode     = 'signin';

  /* ---- Init Supabase client ---- */
  function _initClient() {
    if (_client) return _client;
    if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) return null;
    try {
      _client = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    } catch (e) {
      console.warn('[CloudSync] Failed to init Supabase client:', e);
    }
    return _client;
  }

  /* ---- Queue helpers ---- */
  function _loadQueue() {
    try { return JSON.parse(localStorage.getItem(SYNC_KEYS.queue) || '[]'); }
    catch (_) { return []; }
  }
  function _saveQueue(q) {
    localStorage.setItem(SYNC_KEYS.queue, JSON.stringify(q));
  }
  function enqueue(type, key, data) {
    const q = _loadQueue();
    q.push({ id: Date.now() + '-' + Math.random().toString(36).substring(2), type, key, data, ts: new Date().toISOString(), retries: 0 });
    _saveQueue(q);
    _updateDashboard();
  }

  /* ---- Online / Offline detection ---- */
  function _handleOnline()  { _isOnline = true;  _updateStatus(); syncNow(); }
  function _handleOffline() { _isOnline = false; _updateStatus(); }

  /* ---- Status UI update ---- */
  function _updateStatus() {
    const dot     = document.getElementById('syncDot');
    const txt     = document.getElementById('syncStatusTxt');
    const dashNet = document.getElementById('dashNetStatus');
    if (!dot || !txt) return;
    if (_isSyncing) {
      dot.className = 'sync-dot syncing';
      txt.textContent = 'Sincronizando\u2026';
      if (dashNet) dashNet.textContent = '\uD83D\uDFE1 Sincronizando\u2026';
    } else if (!_isOnline) {
      dot.className = 'sync-dot offline';
      txt.textContent = '\uD83D\uDD34 Offline';
      if (dashNet) dashNet.textContent = '\uD83D\uDD34 Offline';
    } else if (_session) {
      dot.className = 'sync-dot online';
      txt.textContent = '\uD83D\uDFE2 Online';
      if (dashNet) dashNet.textContent = '\uD83D\uDFE2 Online';
    } else {
      dot.className = 'sync-dot';
      txt.textContent = 'Sem login';
      if (dashNet) dashNet.textContent = '\u26AA Sem login';
    }
  }

  /* ---- Dashboard metrics update ---- */
  function _updateDashboard() {
    const q       = _loadQueue();
    const sentEl  = document.getElementById('dashSent');
    const recvEl  = document.getElementById('dashReceived');
    const queueEl = document.getElementById('dashQueue');
    const lastEl  = document.getElementById('dashLastSync');
    const userEl  = document.getElementById('dashUser');
    const authBtn = document.getElementById('authBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    if (sentEl)  sentEl.textContent  = _stats.sent;
    if (recvEl)  recvEl.textContent  = _stats.received;
    if (queueEl) queueEl.textContent = q.length;

    const ts = localStorage.getItem(SYNC_KEYS.timestamp);
    if (lastEl) lastEl.textContent = ts ? new Date(ts).toLocaleString('pt-BR') : '\u2014';

    const user = _session ? (_session.user.email || _session.user.id) : null;
    if (userEl)    userEl.textContent = user || 'N\u00E3o autenticado';
    if (authBtn)   authBtn.textContent = _session ? ('\uD83D\uDC64 ' + (user || 'Conta')) : '\uD83D\uDD10 Login Nuvem';
    if (logoutBtn) logoutBtn.style.display = _session ? 'block' : 'none';

    _updateStatus();
  }

  /* ---- Restore session on page load ---- */
  async function _restoreSession() {
    const sb = _initClient();
    if (!sb) return;
    try {
      const { data } = await sb.auth.getSession();
      if (data && data.session) {
        _session = data.session;
        localStorage.setItem(SYNC_KEYS.authUser, JSON.stringify({ email: data.session.user.email, id: data.session.user.id }));
        _updateDashboard();
        syncNow();
      }
    } catch (e) {
      console.warn('[CloudSync] restoreSession error:', e);
    }
  }

  /* ---- Push: send local queue to Supabase ---- */
  async function _push() {
    const sb = _initClient();
    if (!sb || !_session) return;
    const q = _loadQueue();
    if (!q.length) return;
    const remaining = [];
    for (const item of q) {
      try {
        const payload = {
          user_id   : _session.user.id,
          data_key  : item.key,
          data_value: JSON.stringify(item.data),
          updated_at: item.ts,
        };
        const { error } = await sb.from(SYNC_TABLE).upsert(payload, { onConflict: SYNC_CONFLICT });
        if (error) throw error;
        _stats.sent++;
      } catch (e) {
        item.retries = (item.retries || 0) + 1;
        if (item.retries < MAX_SYNC_RETRIES) remaining.push(item);
        else console.warn('[CloudSync] Dropped item after ' + MAX_SYNC_RETRIES + ' retries:', item.key);
      }
    }
    _saveQueue(remaining);
  }

  /* ---- Pull: fetch remote changes from Supabase ---- */
  async function _pull() {
    const sb = _initClient();
    if (!sb || !_session) return;
    try {
      const lastTs = localStorage.getItem(SYNC_KEYS.timestamp) || '1970-01-01T00:00:00.000Z';
      const { data, error } = await sb
        .from(SYNC_TABLE)
        .select('data_key, data_value, updated_at')
        .eq('user_id', _session.user.id)
        .gt('updated_at', lastTs);
      if (error) throw error;
      if (data && data.length) {
        data.forEach(row => {
          try {
            const parsed  = JSON.parse(row.data_value);
            const localTs = localStorage.getItem(row.data_key + '_ts') || '0';
            if (new Date(row.updated_at) > new Date(localTs)) {
              localStorage.setItem(row.data_key, typeof parsed === 'string' ? parsed : JSON.stringify(parsed));
              localStorage.setItem(row.data_key + '_ts', row.updated_at);
              _stats.received++;
            }
          } catch (_) {}
        });
      }
    } catch (e) {
      console.warn('[CloudSync] pull error:', e);
    }
  }

  /* ---- Main sync cycle ---- */
  async function syncNow() {
    if (_isSyncing || !_isOnline) return;
    const sb = _initClient();
    if (!sb || !_session) return;
    _isSyncing = true;
    _updateStatus();
    try {
      await _push();
      await _pull();
      localStorage.setItem(SYNC_KEYS.timestamp, new Date().toISOString());
    } catch (e) {
      console.warn('[CloudSync] sync error:', e);
    } finally {
      _isSyncing = false;
      _updateDashboard();
    }
  }

  /* ---- Auth modal: open ---- */
  function openAuthModal() {
    if (_session) {
      document.getElementById('syncDashboard').classList.toggle('open');
      return;
    }
    _authMode = 'signin';
    _setAuthMode('signin');
    document.getElementById('authMsg').className = 'auth-msg';
    document.getElementById('authModal').classList.add('open');
    document.getElementById('authEmail').focus();
  }

  function _setAuthMode(mode) {
    _authMode = mode;
    const subtitle  = document.getElementById('authModalSubtitle');
    const submitBtn = document.getElementById('authSubmitBtn');
    const toggleDiv = document.getElementById('authToggle');
    if (mode === 'signin') {
      if (subtitle)  subtitle.textContent = 'Fa\u00E7a login para sincronizar seus dados em nuvem';
      if (submitBtn) submitBtn.textContent = '\uD83D\uDD10 Entrar';
      if (toggleDiv) toggleDiv.innerHTML  = 'Sem conta? <a href="#" id="authSwitchLink">Criar conta agora</a>';
    } else {
      if (subtitle)  subtitle.textContent = 'Crie sua conta para ativar o Cloud Sync';
      if (submitBtn) submitBtn.textContent = '\u2728 Criar Conta';
      if (toggleDiv) toggleDiv.innerHTML  = 'J\u00E1 tem conta? <a href="#" id="authSwitchLink">Fazer login</a>';
    }
    const lnk = document.getElementById('authSwitchLink');
    if (lnk) lnk.onclick = (e) => { e.preventDefault(); _setAuthMode(_authMode === 'signin' ? 'signup' : 'signin'); };
  }

  function _showAuthMsg(text, type) {
    const el = document.getElementById('authMsg');
    if (!el) return;
    el.textContent = text;
    el.className = 'auth-msg ' + type;
  }

  /* ---- Auth: submit (sign-in or sign-up) ---- */
  async function _doAuth() {
    const sb = _initClient();
    if (!sb) {
      _showAuthMsg('\u26A0\uFE0F Configure as credenciais do Supabase no HTML antes de usar o login.', 'error');
      return;
    }
    const email    = (document.getElementById('authEmail')    || {}).value || '';
    const password = (document.getElementById('authPassword') || {}).value || '';
    if (!email || !password) { _showAuthMsg('Preencha e-mail e senha.', 'error'); return; }
    if (password.length < 6) { _showAuthMsg('A senha deve ter pelo menos 6 caracteres.', 'error'); return; }

    const btn = document.getElementById('authSubmitBtn');
    if (btn) { btn.disabled = true; btn.textContent = '\u23F3 Aguarde\u2026'; }

    try {
      let result;
      if (_authMode === 'signup') {
        result = await sb.auth.signUp({ email, password });
      } else {
        result = await sb.auth.signInWithPassword({ email, password });
      }
      const { data, error } = result;
      if (error) throw error;

      if (_authMode === 'signup' && data.user && !data.session) {
        _showAuthMsg('\u2705 Conta criada! Verifique seu e-mail para confirmar.', 'success');
      } else if (data.session) {
        _session = data.session;
        localStorage.setItem(SYNC_KEYS.authUser, JSON.stringify({ email: data.session.user.email, id: data.session.user.id }));
        _showAuthMsg('\u2705 Login realizado com sucesso!', 'success');
        setTimeout(() => {
          document.getElementById('authModal').classList.remove('open');
          _updateDashboard();
          syncNow();
        }, 800);
      }
    } catch (e) {
      const isInvalidCreds = _authMode === 'signin' &&
        (e.status === 400 || (e.message && (e.message.toLowerCase().includes('invalid') || e.message.toLowerCase().includes('credentials'))));
      if (isInvalidCreds) {
        _showAuthMsg('Credenciais inv\u00E1lidas. Deseja criar uma conta? Mude para "Criar conta".', 'error');
      } else {
        _showAuthMsg('Erro: ' + (e.message || 'Falha na autentica\u00E7\u00E3o'), 'error');
      }
    } finally {
      if (btn) { btn.disabled = false; _setAuthMode(_authMode); }
    }
  }

  /* ---- Logout ---- */
  async function logout() {
    const sb = _initClient();
    if (sb) { try { await sb.auth.signOut(); } catch (_) {} }
    _session = null;
    localStorage.removeItem(SYNC_KEYS.authToken);
    localStorage.removeItem(SYNC_KEYS.authUser);
    _updateDashboard();
    document.getElementById('syncDashboard').classList.remove('open');
  }

  /* ---- Bootstrap ---- */
  function init() {
    window.addEventListener('online',  _handleOnline);
    window.addEventListener('offline', _handleOffline);

    const statusBtn  = document.getElementById('syncStatusBtn');
    const syncNowBtn = document.getElementById('syncNowBtn');
    const submitBtn  = document.getElementById('authSubmitBtn');
    const closeBtn   = document.getElementById('authCloseBtn');
    const authModal  = document.getElementById('authModal');
    const switchLink = document.getElementById('authSwitchLink');

    if (statusBtn)  statusBtn.onclick  = () => document.getElementById('syncDashboard').classList.toggle('open');
    if (syncNowBtn) syncNowBtn.onclick = syncNow;
    if (submitBtn)  submitBtn.onclick  = _doAuth;
    if (closeBtn)   closeBtn.onclick   = () => authModal.classList.remove('open');
    if (authModal)  authModal.onclick  = (e) => { if (e.target === authModal) authModal.classList.remove('open'); };
    if (switchLink) switchLink.onclick = (e) => { e.preventDefault(); _setAuthMode('signup'); };

    ['authEmail', 'authPassword'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('keydown', (e) => { if (e.key === 'Enter') _doAuth(); });
    });

    _updateDashboard();
    if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY) _restoreSession();

    _syncInterval = setInterval(() => {
      if (_isOnline && _session && !_isSyncing) syncNow();
    }, AUTO_SYNC_INTERVAL_MS);
  }

  return { init, syncNow, enqueue, openAuthModal, logout };
})();

/* ================================================================
   TAB SYSTEM + MODULE BOOTSTRAP
   ================================================================ */
(function () {
  'use strict';
  let cliInit = false, pdvInit = false, caixaInit = false;

  function onTabActivated(tabId) {
    switch (tabId) {
      case 'dashboardCRM':
        if (typeof DashboardPremium !== 'undefined') DashboardPremium.render();
        break;
      case 'clientes':
        if (!cliInit && typeof ClientesMod !== 'undefined') { ClientesMod.init(); cliInit = true; }
        else if (typeof ClientesMod !== 'undefined') ClientesMod.render();
        break;
      case 'estoqueCRM':
        if (typeof renderEstoqueCRM === 'function') renderEstoqueCRM();
        break;
      case 'pdvPro':
        if (!pdvInit && typeof PDVPro !== 'undefined') { PDVPro.init(); pdvInit = true; }
        if (typeof PDVPro !== 'undefined') PDVPro.renderHistorico();
        break;
      case 'caixa':
        if (!caixaInit) caixaInit = true;
        if (typeof renderCaixa === 'function') renderCaixa();
        break;
    }
  }

  document.getElementById('mainTabs').addEventListener('click', (e) => {
    const btn = e.target.closest('.tab');
    if (!btn) return;
    const tabId = btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    const panel = document.getElementById('panel-' + tabId);
    if (panel) panel.classList.add('active');
    setTimeout(() => onTabActivated(tabId), 30);
  });

  /* Boot sequence */
  CloudSync.init();
  if (typeof seedCRMIfEmpty === 'function') seedCRMIfEmpty();
  onTabActivated('dashboardCRM');
})();
</script>

</body>
</html>
