<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Renova Lotes ‚Äî Dashboard</title>

  <style>
    :root{
      --bg: #0b0f19;
      --border: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.45);
      --shadow: 0 20px 55px rgba(0,0,0,.38);
      --shadow2: 0 12px 34px rgba(0,0,0,.28);
      --radius: 18px;
      --radius2: 14px;
      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.14);
      --danger: rgba(255,70,70,.18);
      --ok: rgba(90,255,170,.18);
      --warn: rgba(255,200,80,.16);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:var(--sans);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(120,160,255,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 30%, rgba(90,255,170,.12), transparent 60%),
        radial-gradient(1000px 700px at 40% 120%, rgba(255,255,255,.06), transparent 65%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    .muted { color: var(--muted); }
    .muted2 { color: var(--muted2); }

    .container{ max-width:1180px; margin:0 auto; padding:22px 16px 30px; }

    .topbar{ display:flex; gap:14px; align-items:flex-start; justify-content:space-between; margin-bottom: 14px; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:46px; height:46px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      display:grid; place-items:center;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      cursor: pointer;
      user-select:none;
    }
    .title{ line-height:1.15; }
    .title h1{ font-size: 18px; margin:0; letter-spacing:.2px; }
    .title p{ margin:4px 0 0; color:var(--muted); font-size: 13px; }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .search{ position:relative; min-width: 270px; }
    .search input{
      width:100%;
      padding: 11px 12px 11px 40px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    .search input:focus{
      border-color: rgba(140,160,255,.55);
      box-shadow: 0 0 0 4px rgba(140,160,255,.12);
    }
    .search .icon{
      position:absolute; left:12px; top:50%;
      transform: translateY(-50%);
      opacity:.82;
      width:18px; height:18px;
      color: rgba(255,255,255,.80);
    }

    .btn{
      border:1px solid var(--border);
      background: var(--btn);
      color:var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      transition: .15s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ background: var(--btn2); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: rgba(140,160,255,.16);
      border-color: rgba(140,160,255,.35);
    }
    .btn.primary:hover{ background: rgba(140,160,255,.22); }
    .btn.danger{ background: var(--danger); border-color: rgba(255,70,70,.25); }
    .btn.ok{ background: var(--ok); border-color: rgba(90,255,170,.25); }
    .btn.warn{ background: var(--warn); border-color: rgba(255,200,80,.22); }
    .btn.small{ padding: 8px 10px; border-radius: 12px; font-size: 13px; }

    .tabs{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin: 14px 0 14px;
      padding: 8px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(255,255,255,.045);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .tab{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      display:flex; justify-content:center; align-items:center; gap:8px;
      transition:.15s ease;
      font-weight: 650;
      letter-spacing: .15px;
    }
    .tab.active{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.12);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .tabpane.hidden{ display:none !important; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.045));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .card .head{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .card .head h3{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .card .body{ padding: 14px; }

    .kpis{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .kpi{
      grid-column: span 6;
      background: rgba(255,255,255,.045);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      padding: 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      min-height: 76px;
    }
    @media (min-width: 920px){ .kpi{ grid-column: span 4; } }
    @media (min-width: 1120px){ .kpi{ grid-column: span 3; } }
    .kpi .label{ font-size: 12px; color:var(--muted); }
    .kpi .value{ margin-top: 6px; font-size: 20px; font-weight: 820; }
    .kpi .hint{ margin-top: 4px; font-size: 11px; color:var(--muted2); }

    .table-wrap{
      overflow:auto;
      max-height: 520px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    table{ width:100%; border-collapse: collapse; min-width: 1180px; }
    thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(18,22,32,.92);
      border-bottom:1px solid rgba(255,255,255,.10);
      user-select:none;
    }
    th, td{
      padding: 10px 10px;
      text-align:left;
      font-size: 13px;
      border-bottom:1px solid rgba(255,255,255,.06);
      white-space: nowrap;
      vertical-align: middle;
    }
    th{ color: var(--muted); font-weight: 750; }
    tbody tr:hover td{ background: rgba(255,255,255,.03); }

    th.sortable{ cursor:pointer; }
    th.sortable:hover{ background: rgba(255,255,255,.06); }
    .sort-ind{ opacity:.9; margin-left:6px; font-size: 12px; }

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .chip.active{
      background: rgba(140,160,255,.16);
      border-color: rgba(140,160,255,.35);
    }
    .chip.ok{ background: rgba(90,255,170,.14); border-color: rgba(90,255,170,.22); }
    .chip.no{ background: rgba(255,70,70,.14); border-color: rgba(255,70,70,.22); }
    .chip.warn{ background: rgba(255,200,80,.14); border-color: rgba(255,200,80,.22); }

    .footer{
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted2);
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .footer code{
      font-family: var(--mono);
      font-size: 12px;
      background: rgba(0,0,0,.25);
      padding: 2px 6px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,.08);
      color: rgba(255,255,255,.85);
    }

    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.58);
      display:none;
      place-items: center;
      padding: 18px;
      z-index: 99;
    }
    .modal{
      width: min(980px, 100%);
      background: rgba(18,22,32,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    .modal .mhead{
      padding: 14px 14px 10px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.06);
      gap: 10px;
    }
    .modal .mhead h3{ margin:0; font-size: 14px; }
    .modal .mbody{ padding: 14px; }
    .modal .mfoot{
      padding: 14px;
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
      border-top:1px solid rgba(255,255,255,.06);
    }
    .form{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 920px){ .form{ grid-template-columns: repeat(3, 1fr); } }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size: 12px; color: var(--muted); }
    .field input, .field select, .field textarea{
      padding: 10px 11px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    .field input:disabled, .field select:disabled, .field textarea:disabled{
      opacity: .7;
      cursor:not-allowed;
    }
    .field textarea{ min-height: 92px; resize: vertical; grid-column: 1 / -1; }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    .section-title{
      margin: 8px 0 2px;
      font-size: 12px;
      color: rgba(255,255,255,.78);
      letter-spacing: .2px;
      font-weight: 800;
    }

    .prod-link{
      background: transparent;
      border: 0;
      padding: 0;
      cursor: pointer;
      color: rgba(200,210,255,.95);
      text-decoration: underline;
      text-underline-offset: 3px;
      font-weight: 700;
    }
    .prod-link:hover{ opacity: .88; }

    /* FOTO 3 slots */
    .photo-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){
      .photo-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .photo-slot{
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      min-height: 150px;
      position: relative;
      cursor: pointer;
    }
    .photo-slot.active{
      outline: 2px solid rgba(140,160,255,.55);
      box-shadow: 0 0 0 4px rgba(140,160,255,.12);
    }
    .photo-slot img{
      width:100%;
      height:170px;
      object-fit:cover;
      display:block;
    }
    .photo-slot .empty{
      height:170px;
      display:grid;
      place-items:center;
      color: var(--muted2);
      font-size: 12px;
    }
    .photo-slot .badge{
      position:absolute;
      top:8px; left:8px;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(18,22,32,.78);
    }
    .photo-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
      justify-content:space-between;
    }

    /* GR√ÅFICOS */
    .charts-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 980px){
      .charts-grid{ grid-template-columns: 1fr 1fr; }
    }
    canvas.chart{
      width: 100%;
      height: 260px;
      display:block;
      background: rgba(0,0,0,.14);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="logo" id="homeLogo" title="Voltar para a p√°gina inicial" aria-label="In√≠cio">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 19V5a2 2 0 0 1 2-2h5v7l2-1 2 1V3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2Z"
              stroke="rgba(255,255,255,.86)" stroke-width="1.6" />
          </svg>
        </div>
        <div class="title">
          <h1>Renova Lotes</h1>
          <p>Controle de lotes, estoque, vendas e indicadores. Tudo salvo no seu navegador.</p>
        </div>
      </div>

      <div class="actions">
        <div class="search">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.8"/>
            <path d="M16.2 16.2 21 21" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
          <input id="q" placeholder="Buscar por c√≥digo, produto, canal, vendedor, local, pagamento..." />
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="chip active" id="fltAll" type="button">Tudo</button>
          <button class="chip" id="fltStock" type="button">S√≥ estoque</button>
          <button class="chip" id="fltSold" type="button">S√≥ vendas</button>
        </div>

        <button class="btn" id="exportBtn" type="button">Exportar JSON</button>
        <button class="btn" id="exportCsvBtn" type="button">Exportar CSV</button>

        <label class="btn" style="gap:8px;">
          Importar
          <input id="importFile" type="file" accept="application/json" style="display:none;">
        </label>

        <button class="btn warn" id="snapshotBtn" type="button" title="Cria um ponto de restaura√ß√£o no navegador">üõü Ponto de restaura√ß√£o</button>
        <button class="btn" id="restoreBtn" type="button" title="Restaura o √∫ltimo ponto de restaura√ß√£o">‚Ü©Ô∏è Restaurar</button>
        <button class="btn danger" id="clearBtn" type="button" title="Apaga tudo (com confirma√ß√£o)">üßπ Limpar base</button>

        <button class="btn primary" id="newBtn" type="button">Novo item</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Navega√ß√£o">
      <button class="tab active" data-tab="visao" type="button">Vis√£o geral</button>
      <button class="tab" data-tab="estoque" type="button">Estoque</button>
      <button class="tab" data-tab="vendas" type="button">Vendas</button>
      <button class="tab" data-tab="graficos" type="button">Gr√°ficos</button>
    </div>

    <!-- VIS√ÉO GERAL -->
    <section id="visao" class="tabpane">
      <div class="card">
        <div class="head"><h3>Vendas</h3><span class="muted2">Resultado e desempenho</span></div>
        <div class="body"><div class="kpis" id="kpiVendas"></div></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="head"><h3>Custos & Efici√™ncia</h3><span class="muted2">Custos e efici√™ncia</span></div>
        <div class="body"><div class="kpis" id="kpiCustos"></div></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="head"><h3>Estoque</h3><span class="muted2">Sa√∫de do estoque</span></div>
        <div class="body"><div class="kpis" id="kpiEstoque"></div></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="head"><h3>Opera√ß√£o</h3><span class="muted2">Velocidade e volume</span></div>
        <div class="body"><div class="kpis" id="kpiOperacao"></div></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="head"><h3>Custo fixo (autom√°tico)</h3><span class="muted2">Sempre recalculado por quantidade</span></div>
        <div class="body"><div class="kpis" id="kpiCustoFixo"></div></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <div class="head"><h3>Resumo r√°pido</h3><span class="muted2">Indicadores principais</span></div>
        <div class="body" id="quickSummary"></div>
      </div>
    </section>

    <!-- ESTOQUE -->
    <section id="estoque" class="tabpane hidden">
      <div class="card">
        <div class="head">
          <h3>Itens em estoque</h3>
          <span class="muted2">Clique no cabe√ßalho para ordenar ‚Ä¢ C√≥digo ordena 1,2,3... ‚Ä¢ Clique no produto: fotos ‚Ä¢ Vendido: venda r√°pida</span>
        </div>
        <div class="body">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="sortable" data-table="estoque" data-sort-key="codigo" data-sort-type="number">C√≥digo <span class="sort-ind" data-ind="estoque:codigo">‚Üï</span></th>
                  <th class="sortable" data-table="estoque" data-sort-key="nomeProduto" data-sort-type="text">Produto <span class="sort-ind" data-ind="estoque:nomeProduto">‚Üï</span></th>
                  <th class="sortable" data-table="estoque" data-sort-key="localEstoque" data-sort-type="text">Local <span class="sort-ind" data-ind="estoque:localEstoque">‚Üï</span></th>
                  <th class="sortable" data-table="estoque" data-sort-key="canalAnuncio" data-sort-type="text">Canal an√∫ncio <span class="sort-ind" data-ind="estoque:canalAnuncio">‚Üï</span></th>
                  <th class="sortable" data-table="estoque" data-sort-key="dataAnuncioISO" data-sort-type="date">Data an√∫ncio <span class="sort-ind" data-ind="estoque:dataAnuncioISO">‚Üï</span></th>
                  <th class="sortable" data-table="estoque" data-sort-key="custoProduto" data-sort-type="number">Custo (auto) <span class="sort-ind" data-ind="estoque:custoProduto">‚Üï</span></th>
                  <th class="sortable" data-table="estoque" data-sort-key="valorAnuncio" data-sort-type="number">Valor an√∫ncio <span class="sort-ind" data-ind="estoque:valorAnuncio">‚Üï</span></th>
                  <th class="sortable" data-table="estoque" data-sort-key="lucroProj" data-sort-type="number">Lucro proj. <span class="sort-ind" data-ind="estoque:lucroProj">‚Üï</span></th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbEstoque"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- VENDAS -->
    <section id="vendas" class="tabpane hidden">
      <div class="card">
        <div class="head">
          <h3>Vendas</h3>
          <span class="muted2">Clique no cabe√ßalho para ordenar ‚Ä¢ C√≥digo ordena 1,2,3... ‚Ä¢ Clique no produto: fotos ‚Ä¢ Pagamento: status e data prevista</span>
        </div>
        <div class="body">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="sortable" data-table="vendas" data-sort-key="codigo" data-sort-type="number">C√≥digo <span class="sort-ind" data-ind="vendas:codigo">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="nomeProduto" data-sort-type="text">Produto <span class="sort-ind" data-ind="vendas:nomeProduto">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="valorVenda" data-sort-type="number">Venda <span class="sort-ind" data-ind="vendas:valorVenda">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="custoProduto" data-sort-type="number">Custo (auto) <span class="sort-ind" data-ind="vendas:custoProduto">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="custoEntrega" data-sort-type="number">Entrega <span class="sort-ind" data-ind="vendas:custoEntrega">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="lucroFinal" data-sort-type="number">Lucro <span class="sort-ind" data-ind="vendas:lucroFinal">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="canalVenda" data-sort-type="text">Canal <span class="sort-ind" data-ind="vendas:canalVenda">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="dataVendaISO" data-sort-type="date">Data venda <span class="sort-ind" data-ind="vendas:dataVendaISO">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="tempoVenda" data-sort-type="number">Tempo (dias) <span class="sort-ind" data-ind="vendas:tempoVenda">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="quemVendeu" data-sort-type="text">Vendedor <span class="sort-ind" data-ind="vendas:quemVendeu">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="pagamentoStatus" data-sort-type="text">Pagamento <span class="sort-ind" data-ind="vendas:pagamentoStatus">‚Üï</span></th>
                  <th class="sortable" data-table="vendas" data-sort-key="pagamentoPrevistoISO" data-sort-type="date">Previsto <span class="sort-ind" data-ind="vendas:pagamentoPrevistoISO">‚Üï</span></th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbVendas"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- GR√ÅFICOS -->
    <section id="graficos" class="tabpane hidden">
      <div class="card">
        <div class="head"><h3>Gr√°ficos</h3><span class="muted2">Tend√™ncias e comparativos</span></div>
        <div class="body">
          <div class="charts-grid">
            <div class="card">
              <div class="head"><h3>Vendas por dia (√∫ltimos 30)</h3><span class="muted2">Quantidade</span></div>
              <div class="body"><canvas id="cSales30" class="chart" width="900" height="260"></canvas></div>
            </div>
            <div class="card">
              <div class="head"><h3>Faturamento por dia (√∫ltimos 30)</h3><span class="muted2">R$</span></div>
              <div class="body"><canvas id="cRevenue30" class="chart" width="900" height="260"></canvas></div>
            </div>
            <div class="card">
              <div class="head"><h3>Vendas por canal</h3><span class="muted2">Quantidade</span></div>
              <div class="body"><canvas id="cSalesByChannel" class="chart" width="900" height="260"></canvas></div>
            </div>
            <div class="card">
              <div class="head"><h3>Lucro por canal</h3><span class="muted2">R$</span></div>
              <div class="body"><canvas id="cProfitByChannel" class="chart" width="900" height="260"></canvas></div>
            </div>
            <div class="card" style="grid-column: 1 / -1;">
              <div class="head"><h3>Aging do estoque</h3><span class="muted2">0‚Äì6d / 7‚Äì14d / 15‚Äì30d / 30+d</span></div>
              <div class="body"><canvas id="cStockAging" class="chart" width="900" height="260"></canvas></div>
            </div>
          </div>

          <div class="muted2" style="margin-top:10px; font-size:12px;">
            Observa√ß√£o: os gr√°ficos s√£o recalculados automaticamente ao editar itens, vender, importar ou duplicar.
          </div>
        </div>
      </div>
    </section>

    <div class="footer">
      <div>Dados salvos em <code>localStorage</code>. Use Exportar/Importar e Ponto de restaura√ß√£o para backup.</div>
      <div class="muted2">Ordena√ß√£o: clique no cabe√ßalho ‚Ä¢ C√≥digo ordena num√©rico ‚Ä¢ Clique no produto: fotos ‚Ä¢ Custo √© autom√°tico</div>
    </div>
  </div>

  <!-- MODAL: CADASTRO/EDI√á√ÉO -->
  <div class="modal-backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="mhead">
        <h3 id="modalTitle">Novo item</h3>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="chip" id="soldLockChip" style="display:none;" title="Itens vendidos ficam travados para n√£o bagun√ßar hist√≥rico">üîí Travado (vendido)</span>
          <button class="btn small" id="closeModal" type="button" title="Fechar">X</button>
        </div>
      </div>

      <div class="mbody">
        <div class="section-title">DADOS DO PRODUTO</div>
        <div class="form">
          <div class="field">
            <label>C√≥digo</label>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="fCodigo" placeholder="Ex: 70" style="flex:1;">
              <button class="btn small" id="nextCodeBtn" type="button" title="Gerar pr√≥ximo c√≥digo">üîÅ Pr√≥ximo</button>
            </div>
          </div>

          <div class="field" style="grid-column: span 2;">
            <label>Nome do produto</label>
            <input id="fProduto" placeholder="Ex: Camiseta Barcelona">
          </div>

          <div class="field">
            <label>Local de estoque</label>
            <input id="fLocalEstoque" placeholder="Ex: Prateleira A / Caixa 2 / Loja">
          </div>

          <div class="field">
            <label>Custo do produto (autom√°tico)</label>
            <input id="fCusto" placeholder="Autom√°tico" disabled>
          </div>

          <div class="field">
            <label>Valor an√∫ncio</label>
            <input id="fAnuncio" placeholder="Ex: 150">
          </div>

          <div class="field">
            <label>Canal do an√∫ncio</label>
            <select id="fCanalAnuncio"></select>
          </div>

          <div class="field">
            <label>Data do an√∫ncio</label>
            <input id="fDataAnuncio" type="date">
          </div>

          <div class="field">
            <label>Vendido?</label>
            <select id="fVendido">
              <option value="nao">N√£o</option>
              <option value="sim">Sim</option>
            </select>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label>Observa√ß√µes</label>
            <textarea id="fObs" placeholder="Links do an√∫ncio, detalhes do cliente, pagamento, etc."></textarea>
          </div>
        </div>

        <div id="salesBlock" style="display:none;">
          <div class="hr"></div>
          <div class="section-title">DADOS DA VENDA (obrigat√≥rios quando Vendido = Sim)</div>

          <div class="form">
            <div class="field">
              <label>Valor da venda *</label>
              <input id="fVenda" placeholder="Ex: 145">
            </div>

            <div class="field">
              <label>Canal da venda *</label>
              <select id="fCanalVenda"></select>
            </div>

            <div class="field">
              <label>Data da venda *</label>
              <input id="fDataVenda" type="date">
            </div>

            <div class="field">
              <label>Quem vendeu *</label>
              <select id="fVendedor"></select>
            </div>

            <div class="field">
              <label>Forma de entrega *</label>
              <select id="fEntrega"></select>
            </div>

            <div class="field">
              <label>Custo entrega *</label>
              <input id="fCustoEntrega" placeholder="Ex: 5,00">
            </div>

            <div class="field">
              <label>Status pagamento</label>
              <select id="fPagStatus"></select>
            </div>

            <div class="field">
              <label>Pagamento previsto</label>
              <input id="fPagPrev" type="date">
            </div>
          </div>

          <div class="hint-red" id="requiredHint" style="color: rgba(255,170,170,.92); font-size: 12px; margin-top: 6px; display:none;">
            Preencha todos os campos obrigat√≥rios da venda para salvar como ‚ÄúVendido‚Äù.
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="head"><h3>Pr√©via de c√°lculos</h3><span class="muted2">Atualiza conforme voc√™ digita</span></div>
          <div class="body" id="calcPreview"></div>
        </div>
      </div>

      <div class="mfoot">
        <button class="btn" id="cancelBtn" type="button">Cancelar</button>
        <button class="btn danger" id="deleteBtn" type="button" style="display:none;">Excluir</button>
        <button class="btn primary" id="saveBtn" type="button">Salvar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: VENDA R√ÅPIDA -->
  <div class="modal-backdrop" id="sellBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="sellTitle">
      <div class="mhead">
        <h3 id="sellTitle">Venda r√°pida</h3>
        <button class="btn small" id="closeSell" type="button" title="Fechar">X</button>
      </div>
      <div class="mbody">
        <div class="muted2" id="sellMeta">‚Äî</div>

        <div class="hr"></div>
        <div class="section-title">DADOS DA VENDA</div>

        <div class="form">
          <div class="field">
            <label>Valor da venda *</label>
            <input id="sVenda" placeholder="Ex: 145">
          </div>

          <div class="field">
            <label>Canal da venda *</label>
            <select id="sCanal"></select>
          </div>

          <div class="field">
            <label>Data da venda *</label>
            <input id="sData" type="date">
          </div>

          <div class="field">
            <label>Quem vendeu *</label>
            <select id="sVendedor"></select>
          </div>

          <div class="field">
            <label>Forma de entrega *</label>
            <select id="sEntrega"></select>
          </div>

          <div class="field">
            <label>Custo entrega *</label>
            <input id="sCustoEntrega" placeholder="Ex: 0,00">
          </div>

          <div class="field">
            <label>Status pagamento</label>
            <select id="sPagStatus"></select>
          </div>

          <div class="field">
            <label>Pagamento previsto</label>
            <input id="sPagPrev" type="date">
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label>Observa√ß√µes (opcional)</label>
            <textarea id="sObs" placeholder="Ex: Vendido para X, pagamento em tal data..."></textarea>
          </div>
        </div>

        <div id="sellHint" style="color: rgba(255,170,170,.92); font-size: 12px; margin-top: 8px; display:none;">
          Preencha os campos obrigat√≥rios (*) para concluir a venda.
        </div>

        <div class="muted2" style="margin-top:10px; font-size:12px;">
          Dica: o custo do produto √© autom√°tico (R$ 6.050,00 √∑ quantidade total de itens).
        </div>
      </div>
      <div class="mfoot">
        <button class="btn" id="cancelSell" type="button">Cancelar</button>
        <button class="btn ok" id="confirmSell" type="button">‚úÖ Concluir venda</button>
      </div>
    </div>
  </div>

  <!-- MODAL: FOTOS (3 por produto) -->
  <div class="modal-backdrop" id="photoBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="photoTitle">
      <div class="mhead">
        <h3 id="photoTitle">Fotos do produto</h3>
        <button class="btn small" id="closePhoto" type="button" title="Fechar">X</button>
      </div>
      <div class="mbody">
        <div class="muted2" id="photoMetaLine">‚Äî</div>

        <div style="margin-top:12px;" class="photo-grid" id="photoGrid"></div>

        <div class="photo-actions">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <label class="btn primary">
              Anexar na foto selecionada
              <input id="photoFile" type="file" accept="image/*" style="display:none;">
            </label>
            <button class="btn danger" id="removeSelectedPhotoBtn" type="button">Remover foto selecionada</button>
          </div>
          <div class="muted2" style="font-size:12px;">Dica: clique em um slot (1/2/3) para selecionar.</div>
        </div>

        <div class="muted2" style="margin-top:10px; font-size:12px;">
          As fotos ficam salvas no seu navegador (junto do item). Ao exportar, elas v√£o no JSON tamb√©m.
        </div>
      </div>
      <div class="mfoot">
        <button class="btn" id="closePhoto2" type="button">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "renova_lotes_html_v6";
    const SNAP_KEY = STORAGE_KEY + "_snapshots";

    // ‚úÖ CUSTO FIXO TOTAL (divide pela quantidade de produtos cadastrados)
    const TOTAL_CUSTO_FIXO = 6050.00;

    const CANAIS = ["Instagram","Facebook","Google Ads","WhatsApp","TikTok","Marketplace","Indica√ß√£o","Org√¢nico","Outro"];
    const VENDEDORES = ["Dennis","Calebe","David","Outro"];
    const ENTREGAS = ["Retirada","Motoboy","Correios","Transportadora","Entrega pr√≥pria","Digital","Outro","Uber"];
    const PAG_STATUS = ["Pendente","Pago","Parcial","A combinar","Sem informa√ß√£o"];

    // Seed (vai ser substitu√≠do pelos seus dados quando voc√™ importar o JSON)
    const SEED = [
      {
        "id":"bfdf9bc3d924119c7845a86e",
        "codigo":"1",
        "nomeProduto":"Camiseta Milan",
        "localEstoque":"Dennis",
        "custoProduto":0,
        "valorAnuncio":150,
        "canalAnuncio":"Outro",
        "dataAnuncioISO":"",
        "vendido":false,
        "valorVenda":0,
        "canalVenda":"",
        "dataVendaISO":"",
        "quemVendeu":"",
        "formaEntrega":"",
        "custoEntrega":0,
        "pagamentoStatus":"Pendente",
        "pagamentoPrevistoISO":"",
        "observacoes":"Camiseta do Milan - N√∫mero 80 Ronaldinho Ga√∫cho ",
        "photos":["","",""]
      }
    ];

    const $ = (id) => document.getElementById(id);
    function uid(){ return (Math.random().toString(16).slice(2) + Date.now().toString(16)); }
    function safe(n){ return Number.isFinite(n) ? n : 0; }

    function parseMoney(v){
      if (v === null || v === undefined) return 0;
      if (typeof v === "number") return Number.isFinite(v) ? v : 0;
      const s = String(v).replace(/R\$\s?/g,"").replace(/\./g,"").replace(/,/g,".").trim();
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function brl(n){
      const num = Number.isFinite(n) ? n : 0;
      return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(num);
    }
    function pct(p){
      const num = Number.isFinite(p) ? p : 0;
      return new Intl.NumberFormat("pt-BR",{style:"percent",maximumFractionDigits:1}).format(num);
    }
    function daysBetweenISO(a,b){
      if(!a || !b) return null;
      const da = new Date(a + "T00:00:00");
      const db = new Date(b + "T00:00:00");
      const diff = db.getTime() - da.getTime();
      if(!Number.isFinite(diff)) return null;
      return Math.round(diff / (1000*60*60*24));
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function dateValue(iso){
      if(!iso) return null;
      const d = new Date(iso + "T00:00:00");
      return Number.isFinite(d.getTime()) ? d.getTime() : null;
    }
    function nowISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // ============================
    // ‚úÖ CUSTO FIXO AUTOM√ÅTICO
    // ============================
    function custoUnitarioAtual(){
      const qtd = Math.max(1, items.length);
      return TOTAL_CUSTO_FIXO / qtd;
    }
    function aplicarCustoFixoEmTodos(){
      const cu = custoUnitarioAtual();
      items = items.map(x => ({ ...x, custoProduto: cu }));
    }

    // ============================
    // ‚úÖ C√ìDIGO AUTO + NUM√âRICO
    // ============================
    function extractCodigoNumber(codigo){
      const raw = String(codigo ?? "").trim();
      const m = raw.match(/^\d+/);
      if(!m) return null;
      const n = Number(m[0]);
      return Number.isFinite(n) ? n : null;
    }
    function getNextCodigo(){
      const nums = items.map(i => extractCodigoNumber(i.codigo)).filter(n => n !== null);
      const max = nums.length ? Math.max(...nums) : 0;
      return String(max + 1);
    }
    function setNextCodigoIntoField(){
      $("fCodigo").value = getNextCodigo();
    }

    let items = [];
    let editingId = null;

    let photoEditingId = null;
    let activePhotoSlot = 0;

    let sellEditingId = null;

    const filterState = { mode: "all" };

    const sortState = {
      estoque: { key: "codigo", dir: "asc", type: "number" },
      vendas:  { key: "dataVendaISO", dir: "desc", type: "date" }
    };

    function normalizeItemShape(x){
      const photos = Array.isArray(x.photos) ? x.photos.slice(0,3) : ["","",""];
      while(photos.length < 3) photos.push("");

      if(x.photoDataUrl && !photos.some(Boolean)){
        photos[0] = String(x.photoDataUrl || "");
      }

      return {
        id: x.id || uid(),
        codigo: String(x.codigo ?? "").trim(),
        nomeProduto: String(x.nomeProduto ?? "").trim(),
        localEstoque: String(x.localEstoque ?? ""),
        custoProduto: safe(Number(x.custoProduto)),
        valorAnuncio: safe(Number(x.valorAnuncio)),
        canalAnuncio: String(x.canalAnuncio ?? ""),
        dataAnuncioISO: String(x.dataAnuncioISO ?? ""),
        vendido: Boolean(x.vendido),
        valorVenda: safe(Number(x.valorVenda)),
        canalVenda: String(x.canalVenda ?? ""),
        dataVendaISO: String(x.dataVendaISO ?? ""),
        quemVendeu: String(x.quemVendeu ?? ""),
        formaEntrega: String(x.formaEntrega ?? ""),
        custoEntrega: safe(Number(x.custoEntrega)),
        pagamentoStatus: String(x.pagamentoStatus ?? "Pendente"),
        pagamentoPrevistoISO: String(x.pagamentoPrevistoISO ?? ""),
        observacoes: String(x.observacoes ?? ""),
        photos
      };
    }

    function save(){
      aplicarCustoFixoEmTodos();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)){
            items = parsed.map(normalizeItemShape);
            aplicarCustoFixoEmTodos();
            return;
          }
        }
      }catch(e){}
      items = SEED.map(normalizeItemShape);
      aplicarCustoFixoEmTodos();
      save();
    }

    function setTab(tab){
      document.querySelectorAll(".tab").forEach(b => b.classList.toggle("active", b.dataset.tab === tab));
      ["visao","estoque","vendas","graficos"].forEach(id => $(id).classList.toggle("hidden", id!==tab));
      render();
    }

    function compute(){
      const sold = items.filter(i => i.vendido && safe(i.valorVenda) > 0);
      const totalVendas = sold.length;

      const faturamento = sold.reduce((a,i)=>a+safe(i.valorVenda),0);
      const custoProdutos = sold.reduce((a,i)=>a+safe(i.custoProduto),0);
      const custoEntregas = sold.reduce((a,i)=>a+safe(i.custoEntrega),0);
      const lucroFinal = sold.reduce((a,i)=>a + safe(i.valorVenda) - safe(i.custoProduto) - safe(i.custoEntrega),0);

      const ticketMedio = totalVendas ? faturamento/totalVendas : 0;
      const lucroMedio = totalVendas ? lucroFinal/totalVendas : 0;

      const margemLucro = faturamento ? lucroFinal/faturamento : 0;
      const entregaPct = faturamento ? custoEntregas/faturamento : 0;
      const roiProdutos = custoProdutos ? lucroFinal/custoProdutos : 0;

      const tempos = sold.map(i => daysBetweenISO(i.dataAnuncioISO, i.dataVendaISO)).filter(d => typeof d==="number");
      const tempoMedio = tempos.length ? (tempos.reduce((a,b)=>a+b,0)/tempos.length) : null;

      const totalItens = items.length;
      const totalEstoque = items.filter(i => !i.vendido).length;
      const taxaVenda = totalItens ? totalVendas/totalItens : 0;

      const valorAnunciadoEstoque = items.filter(i=>!i.vendido).reduce((a,i)=>a+safe(i.valorAnuncio),0);
      const custoEstoque = items.filter(i=>!i.vendido).reduce((a,i)=>a+safe(i.custoProduto),0);
      const potencialLucroEstoque = items.filter(i=>!i.vendido).reduce((a,i)=>a+(safe(i.valorAnuncio)-safe(i.custoProduto)),0);

      const pagos = sold.filter(i => (i.pagamentoStatus||"").toLowerCase() === "pago").length;
      const pendentes = sold.filter(i => (i.pagamentoStatus||"").toLowerCase() === "pendente").length;

      return {
        totalVendas,faturamento,custoProdutos,custoEntregas,lucroFinal,
        ticketMedio,lucroMedio,margemLucro,entregaPct,roiProdutos,
        tempoMedio,totalItens,totalEstoque,taxaVenda,
        valorAnunciadoEstoque,custoEstoque,potencialLucroEstoque,
        pagos, pendentes
      };
    }

    function renderKPIs(m){
      const groups = {
        kpiVendas: [
          { label:"Faturamento", value:brl(m.faturamento), hint:"Soma do valor de venda" },
          { label:"Lucro final", value:brl(m.lucroFinal), hint:"Venda ‚àí custo ‚àí entrega" },
          { label:"Margem", value:pct(m.margemLucro), hint:"Lucro / faturamento" },
          { label:"Ticket m√©dio", value:brl(m.ticketMedio), hint:"Faturamento / vendas" },
          { label:"Lucro m√©dio", value:brl(m.lucroMedio), hint:"Lucro / vendas" },
          { label:"Pagamentos (pago)", value:String(m.pagos), hint:"Vendas com status = Pago" },
          { label:"Pagamentos (pendente)", value:String(m.pendentes), hint:"Vendas com status = Pendente" },
        ],
        kpiCustos: [
          { label:"Custo produtos (vendidos)", value:brl(m.custoProdutos), hint:"Soma do custo (vendidos)" },
          { label:"Custo entregas", value:brl(m.custoEntregas), hint:"Soma entrega (vendidos)" },
          { label:"% entrega", value:pct(m.entregaPct), hint:"Entrega / faturamento" },
          { label:"ROI", value:pct(m.roiProdutos), hint:"Lucro / custo produtos" },
        ],
        kpiEstoque: [
          { label:"Em estoque", value:String(m.totalEstoque), hint:"Itens n√£o vendidos" },
          { label:"Custo do estoque", value:brl(m.custoEstoque), hint:"Soma do custo (estoque)" },
          { label:"Valor anunciado (estoque)", value:brl(m.valorAnunciadoEstoque), hint:"Soma do an√∫ncio (estoque)" },
          { label:"Potencial lucro (estoque)", value:brl(m.potencialLucroEstoque), hint:"(An√∫ncio ‚àí custo) no estoque" },
        ],
        kpiOperacao: [
          { label:"Total de vendas", value:String(m.totalVendas), hint:"Itens vendidos com valor" },
          { label:"Taxa de venda", value:pct(m.taxaVenda), hint:"Vendas / itens" },
          { label:"Tempo m√©dio", value:(m.tempoMedio===null?"‚Äî":Math.round(m.tempoMedio)+" d"), hint:"An√∫ncio ‚Üí venda" },
          { label:"Itens cadastrados", value:String(m.totalItens), hint:"Total na base" },
        ],
        kpiCustoFixo: [
          { label:"Total fixo", value: brl(TOTAL_CUSTO_FIXO), hint:"Valor total gasto" },
          { label:"Quantidade de produtos", value: String(Math.max(1, items.length)), hint:"Total de itens cadastrados" },
          { label:"Custo unit√°rio (auto)", value: brl(custoUnitarioAtual()), hint:"Total √∑ quantidade" },
          { label:"Impacto do custo", value: (items.length<=1?"‚Äî":"‚Üì ao aumentar itens"), hint:"Quanto mais itens, menor o custo unit√°rio" },
        ],
      };

      Object.entries(groups).forEach(([gridId, list])=>{
        const grid = $(gridId);
        grid.innerHTML = "";
        list.forEach(k=>{
          const div = document.createElement("div");
          div.className = "kpi";
          div.innerHTML = `<div class="label">${k.label}</div><div class="value">${k.value}</div><div class="hint">${k.hint}</div>`;
          grid.appendChild(div);
        });
      });
    }

    function renderQuick(m){
      const estoque = items.filter(i=>!i.vendido).length;
      $("quickSummary").innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <span class="chip ok">üßæ Vendas: <b>${m.totalVendas}</b></span>
          <span class="chip">üí∞ Faturamento: <b>${brl(m.faturamento)}</b></span>
          <span class="chip">‚úÖ Lucro: <b>${brl(m.lucroFinal)}</b></span>
          <span class="chip">üì¶ Estoque: <b>${estoque}</b></span>
          <span class="chip warn">üß± Custo unit√°rio (auto): <b>${brl(custoUnitarioAtual())}</b></span>
          <span class="chip">‚è± Tempo m√©dio: <b>${m.tempoMedio===null?"‚Äî":Math.round(m.tempoMedio)+"d"}</b></span>
        </div>
      `;
    }

    // ===== filtros =====
    function setChipActive(){
      $("fltAll").classList.toggle("active", filterState.mode==="all");
      $("fltStock").classList.toggle("active", filterState.mode==="stock");
      $("fltSold").classList.toggle("active", filterState.mode==="sold");
    }

    function getFiltered(){
      const q = ($("q").value || "").trim().toLowerCase();
      let base = items;

      if(filterState.mode === "stock") base = base.filter(i=>!i.vendido);
      if(filterState.mode === "sold") base = base.filter(i=>i.vendido);

      if(!q) return base;

      return base.filter(i=>{
        const hay = [
          i.codigo,i.nomeProduto,i.localEstoque,i.canalAnuncio,i.canalVenda,i.quemVendeu,i.formaEntrega,
          i.pagamentoStatus,i.pagamentoPrevistoISO,i.observacoes
        ].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    // ===== ordena√ß√£o =====
    function normText(v){ return String(v ?? "").toLowerCase(); }

    function getSortValue(item, key, type){
      if(key === "lucroProj") return safe(item.valorAnuncio) - safe(item.custoProduto);
      if(key === "lucroFinal") return safe(item.valorVenda) - safe(item.custoProduto) - safe(item.custoEntrega);
      if(key === "tempoVenda") return daysBetweenISO(item.dataAnuncioISO, item.dataVendaISO) ?? -1;
      if(key === "codigo"){
        const n = extractCodigoNumber(item.codigo);
        return n === null ? 1e15 : n;
      }

      const v = item[key];
      if(type === "number") return safe(Number(v));
      if(type === "date") return dateValue(v) ?? -1;
      return normText(v);
    }

    function sortList(list, tableName){
      const st = sortState[tableName];
      const dirMul = st.dir === "asc" ? 1 : -1;
      return [...list].sort((a,b)=>{
        const va = getSortValue(a, st.key, st.type);
        const vb = getSortValue(b, st.key, st.type);
        if(st.type === "text"){
          if(va < vb) return -1*dirMul;
          if(va > vb) return  1*dirMul;
          return 0;
        }
        return (va - vb) * dirMul;
      });
    }

    function setSortIndicator(tableName){
      document.querySelectorAll(`[data-ind^="${tableName}:"]`).forEach(el => el.textContent = "‚Üï");
      const st = sortState[tableName];
      const ind = document.querySelector(`[data-ind="${tableName}:${st.key}"]`);
      if(ind) ind.textContent = st.dir === "asc" ? "‚ñ≤" : "‚ñº";
    }

    function photoCount(it){
      const arr = Array.isArray(it.photos) ? it.photos : ["","",""];
      return arr.filter(Boolean).length;
    }

    // ===== DUPLICAR =====
    function nextCopyCode(baseCode){
      const b = String(baseCode || "").trim();
      if(!b) return "COPIA-1";
      const prefix = b + "-";
      const existing = items
        .map(x=>String(x.codigo||""))
        .filter(c=>c.startsWith(prefix))
        .map(c=>{
          const tail = c.slice(prefix.length);
          const n = Number(tail);
          return Number.isFinite(n) ? n : null;
        })
        .filter(n=>n!==null);
      const next = (existing.length ? Math.max(...existing) : 0) + 1;
      return `${b}-${next}`;
    }

    window.duplicateItem = function(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;

      const copy = JSON.parse(JSON.stringify(it));
      copy.id = uid();
      copy.codigo = nextCopyCode(it.codigo);

      copy.vendido = false;
      copy.valorVenda = 0;
      copy.canalVenda = "";
      copy.dataVendaISO = "";
      copy.quemVendeu = "";
      copy.formaEntrega = "";
      copy.custoEntrega = 0;
      copy.pagamentoStatus = "Pendente";
      copy.pagamentoPrevistoISO = "";

      items.unshift(normalizeItemShape(copy));
      aplicarCustoFixoEmTodos();
      save(); render();
      window.openEdit(copy.id);
    }

    // ===== tabelas =====
    function renderTables(filtered){
      const estoqueBase = filtered.filter(i=>!i.vendido);
      const vendasBase  = filtered.filter(i=>i.vendido);

      const estoque = sortList(estoqueBase, "estoque");
      const vendas  = sortList(vendasBase, "vendas");

      setSortIndicator("estoque");
      setSortIndicator("vendas");

      const tbE = $("tbEstoque");
      tbE.innerHTML = "";
      if(!estoque.length){
        tbE.innerHTML = `<tr><td colspan="9" class="muted">Nenhum item em estoque com o filtro atual.</td></tr>`;
      } else {
        estoque.forEach(i=>{
          const lucroProj = safe(i.valorAnuncio) - safe(i.custoProduto);
          const pc = photoCount(i);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${escapeHtml(i.codigo)}</b></td>
            <td>
              <button class="prod-link" type="button" onclick="openPhoto('${i.id}')">${escapeHtml(i.nomeProduto)}</button>
              ${pc ? `<span class="muted2" style="margin-left:8px;">üì∑ ${pc}/3</span>` : ``}
            </td>
            <td>${escapeHtml(i.localEstoque || "‚Äî")}</td>
            <td>${escapeHtml(i.canalAnuncio || "‚Äî")}</td>
            <td>${i.dataAnuncioISO || "‚Äî"}</td>
            <td>${brl(safe(i.custoProduto))}</td>
            <td>${brl(safe(i.valorAnuncio))}</td>
            <td>${brl(lucroProj)}</td>
            <td>
              <button class="btn small" type="button" onclick="openEdit('${i.id}')">‚úèÔ∏è Editar</button>
              <button class="btn small" type="button" onclick="duplicateItem('${i.id}')">üß¨ Duplicar</button>
              <button class="btn small ok" type="button" onclick="openQuickSell('${i.id}')">‚úÖ Vendido</button>
              <button class="btn small danger" type="button" onclick="removeItem('${i.id}')">üóë</button>
            </td>
          `;
          tbE.appendChild(tr);
        });
      }

      const tbV = $("tbVendas");
      tbV.innerHTML = "";
      if(!vendas.length){
        tbV.innerHTML = `<tr><td colspan="13" class="muted">Nenhuma venda com o filtro atual.</td></tr>`;
      } else {
        vendas.forEach(i=>{
          const lucroFinal = safe(i.valorVenda) - safe(i.custoProduto) - safe(i.custoEntrega);
          const tempo = daysBetweenISO(i.dataAnuncioISO, i.dataVendaISO);
          const pc = photoCount(i);

          const ps = (i.pagamentoStatus || "‚Äî");
          const psLower = ps.toLowerCase();
          const psChipClass = psLower === "pago" ? "ok" : (psLower === "pendente" ? "no" : "warn");

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${escapeHtml(i.codigo)}</b></td>
            <td>
              <button class="prod-link" type="button" onclick="openPhoto('${i.id}')">${escapeHtml(i.nomeProduto)}</button>
              ${pc ? `<span class="muted2" style="margin-left:8px;">üì∑ ${pc}/3</span>` : ``}
            </td>
            <td>${brl(safe(i.valorVenda))}</td>
            <td>${brl(safe(i.custoProduto))}</td>
            <td>${brl(safe(i.custoEntrega))}</td>
            <td><b>${brl(lucroFinal)}</b></td>
            <td>${escapeHtml(i.canalVenda || "‚Äî")}</td>
            <td>${i.dataVendaISO || "‚Äî"}</td>
            <td>${tempo===null ? "‚Äî" : tempo}</td>
            <td>${escapeHtml(i.quemVendeu || "‚Äî")}</td>
            <td><span class="chip ${psChipClass}" style="cursor:default;">${escapeHtml(ps)}</span></td>
            <td>${i.pagamentoPrevistoISO || "‚Äî"}</td>
            <td>
              <button class="btn small" type="button" onclick="openEdit('${i.id}')">‚úèÔ∏è Editar</button>
              <button class="btn small" type="button" onclick="markSold('${i.id}', false)">‚Ü©Ô∏è Estoque</button>
              <button class="btn small" type="button" onclick="duplicateItem('${i.id}')">üß¨ Duplicar</button>
              <button class="btn small danger" type="button" onclick="removeItem('${i.id}')">üóë</button>
            </td>
          `;
          tbV.appendChild(tr);
        });
      }
    }

    // ===== modal =====
    function fillSelect(id, list, allowEmpty=false){
      const s = $(id);
      s.innerHTML = "";
      if(allowEmpty){
        const opt = document.createElement("option");
        opt.value = ""; opt.textContent = "‚Äî";
        s.appendChild(opt);
      }
      list.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = v; opt.textContent = v;
        s.appendChild(opt);
      });
    }

    function openModal(title){
      $("modalTitle").textContent = title;
      $("backdrop").style.display = "grid";
    }
    function closeModal(){
      $("backdrop").style.display = "none";
      editingId = null;
      $("deleteBtn").style.display = "none";
      $("requiredHint").style.display = "none";
      $("soldLockChip").style.display = "none";
      applySoldLockUI(false);
    }

    function openSellModal(){
      $("sellBackdrop").style.display = "grid";
    }
    function closeSellModal(){
      $("sellBackdrop").style.display = "none";
      sellEditingId = null;
      $("sellHint").style.display = "none";
      ["sVenda","sCanal","sData","sVendedor","sEntrega","sCustoEntrega","sPagStatus","sPagPrev","sObs"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        if(el.tagName === "SELECT") el.value = "";
        else el.value = "";
      });
    }

    function clearSaleFields(){
      $("fVenda").value = "";
      $("fCanalVenda").value = "";
      $("fDataVenda").value = "";
      $("fVendedor").value = "";
      $("fEntrega").value = "";
      $("fCustoEntrega").value = "";
      $("fPagStatus").value = "Pendente";
      $("fPagPrev").value = "";
    }

    function toggleSalesBlock(show){
      $("salesBlock").style.display = show ? "block" : "none";
      ["fVenda","fCanalVenda","fDataVenda","fVendedor","fEntrega","fCustoEntrega","fPagStatus","fPagPrev"].forEach(id=>{
        $(id).disabled = !show;
      });
    }

    function applySoldLockUI(isSoldLocked){
      // ‚úÖ trava campos do produto quando vendido (para n√£o bagun√ßar hist√≥rico)
      const lockIds = ["fProduto","fLocalEstoque","fAnuncio","fCanalAnuncio","fDataAnuncio"];
      lockIds.forEach(id => $(id).disabled = isSoldLocked);

      // custo √© sempre travado
      $("fCusto").disabled = true;

      // vendido? (se j√° est√° vendido, n√£o deixa voltar pra "n√£o" aqui ‚Äî isso √© feito pelo bot√£o "‚Ü©Ô∏è Estoque")
      $("fVendido").disabled = isSoldLocked;

      // c√≥digo j√° √© travado ao editar
    }

    function resetForm(){
      $("fCodigo").value = "";
      $("fProduto").value = "";
      $("fLocalEstoque").value = "";
      $("fCusto").value = String(custoUnitarioAtual()).replace(".",",");
      $("fAnuncio").value = "";
      $("fCanalAnuncio").value = "Facebook";
      $("fDataAnuncio").value = "";
      $("fVendido").value = "nao";
      $("fObs").value = "";
      clearSaleFields();
      toggleSalesBlock(false);
      $("soldLockChip").style.display = "none";
      applySoldLockUI(false);
      updateCalcPreview();
    }

    function openCreate(){
      editingId = null;
      $("deleteBtn").style.display = "none";
      resetForm();

      $("fCodigo").disabled = false;
      $("nextCodeBtn").disabled = false;
      setNextCodigoIntoField();

      $("fCusto").value = String(custoUnitarioAtual()).replace(".",",");

      openModal("Novo item");
      setTimeout(()=>$("fProduto").focus(), 50);
    }

    window.openEdit = function(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      editingId = id;
      $("deleteBtn").style.display = "inline-flex";

      // trava c√≥digo ao editar
      $("fCodigo").disabled = true;
      $("nextCodeBtn").disabled = true;

      $("fCodigo").value = it.codigo || "";
      $("fProduto").value = it.nomeProduto || "";
      $("fLocalEstoque").value = it.localEstoque || "";

      // custo sempre autom√°tico
      $("fCusto").value = String(custoUnitarioAtual()).replace(".",",");

      $("fAnuncio").value = String(safe(it.valorAnuncio)).replace(".",",");
      $("fCanalAnuncio").value = it.canalAnuncio || "Facebook";
      $("fDataAnuncio").value = it.dataAnuncioISO || "";
      $("fObs").value = it.observacoes || "";

      const sold = !!it.vendido;
      $("fVendido").value = sold ? "sim" : "nao";
      toggleSalesBlock(sold);

      if(sold){
        $("fVenda").value = it.valorVenda ? String(safe(it.valorVenda)).replace(".",",") : "";
        $("fCanalVenda").value = it.canalVenda || "";
        $("fDataVenda").value = it.dataVendaISO || "";
        $("fVendedor").value = it.quemVendeu || "";
        $("fEntrega").value = it.formaEntrega || "";
        $("fCustoEntrega").value = String(safe(it.custoEntrega)).replace(".",",");
        $("fPagStatus").value = it.pagamentoStatus || "Pendente";
        $("fPagPrev").value = it.pagamentoPrevistoISO || "";

        $("soldLockChip").style.display = "inline-flex";
        applySoldLockUI(true);
      } else {
        clearSaleFields();
        $("soldLockChip").style.display = "none";
        applySoldLockUI(false);
      }

      $("requiredHint").style.display = "none";
      updateCalcPreview();
      openModal("Editar item");
    }

    function readForm(){
      // custo SEMPRE autom√°tico
      const custo = custoUnitarioAtual();
      const anuncio = parseMoney($("fAnuncio").value);
      const vendido = $("fVendido").value === "sim";

      const venda = parseMoney($("fVenda").value);
      const custoEntrega = parseMoney($("fCustoEntrega").value);

      const itemAtual = editingId ? items.find(x=>x.id===editingId) : null;

      return {
        id: editingId || uid(),
        codigo: ($("fCodigo").value || "").trim(),
        nomeProduto: ($("fProduto").value || "").trim(),
        localEstoque: ($("fLocalEstoque").value || "").trim(),
        custoProduto: custo,
        valorAnuncio: anuncio,
        canalAnuncio: ($("fCanalAnuncio").value || "").trim(),
        dataAnuncioISO: ($("fDataAnuncio").value || "").trim(),
        observacoes: ($("fObs").value || ""),
        vendido,
        valorVenda: vendido ? venda : 0,
        canalVenda: vendido ? ($("fCanalVenda").value || "").trim() : "",
        dataVendaISO: vendido ? ($("fDataVenda").value || "").trim() : "",
        quemVendeu: vendido ? ($("fVendedor").value || "").trim() : "",
        formaEntrega: vendido ? ($("fEntrega").value || "").trim() : "",
        custoEntrega: vendido ? custoEntrega : 0,
        pagamentoStatus: vendido ? ($("fPagStatus").value || "Pendente") : "Pendente",
        pagamentoPrevistoISO: vendido ? (($("fPagPrev").value || "").trim()) : "",
        photos: itemAtual?.photos ? itemAtual.photos.slice(0,3) : ["","",""]
      };
    }

    function validateProduct(it){
      if(!it.codigo) return "Preencha o C√≥digo.";
      if(!it.nomeProduto) return "Preencha o Nome do produto.";

      const codeNorm = String(it.codigo).trim().toLowerCase();
      const dup = items.some(x => x.id !== it.id && String(x.codigo||"").trim().toLowerCase() === codeNorm);
      if(dup) return "Este C√≥digo j√° existe. Use outro (ou clique em üîÅ Pr√≥ximo no Novo item).";

      return null;
    }

    function validateSaleIfNeeded(it){
      if(!it.vendido) return null;
      if(!(it.valorVenda > 0)) return "Preencha o Valor da venda.";
      if(!it.canalVenda) return "Preencha o Canal da venda.";
      if(!it.dataVendaISO) return "Preencha a Data da venda.";
      if(!it.quemVendeu) return "Preencha Quem vendeu.";
      if(!it.formaEntrega) return "Preencha a Forma de entrega.";
      const raw = ($("fCustoEntrega").value || "").trim();
      if(raw === "") return "Preencha o Custo entrega (pode ser 0).";
      return null;
    }

    function updateCalcPreview(){
      const custo = custoUnitarioAtual();
      $("fCusto").value = String(custo).replace(".",",");

      const anuncio = parseMoney($("fAnuncio").value);
      const venda = parseMoney($("fVenda").value);
      const custoEntrega = parseMoney($("fCustoEntrega").value);

      const lucroProj = anuncio - custo;
      const lucroFinal = venda - custo - custoEntrega;
      const tempo = daysBetweenISO($("fDataAnuncio").value, $("fDataVenda").value);

      $("calcPreview").innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <span class="chip">üß± Custo (auto): <b>${brl(custo)}</b></span>
          <span class="chip">üì£ Lucro projetado: <b>${brl(lucroProj)}</b></span>
          <span class="chip">‚úÖ Lucro final: <b>${brl(lucroFinal)}</b></span>
          <span class="chip">‚è± Tempo venda: <b>${tempo===null ? "‚Äî" : (tempo+" dias")}</b></span>
        </div>
        <div class="muted2" style="margin-top:10px;">
          F√≥rmulas: custo = 6.050 √∑ itens ‚Ä¢ lucro proj. = an√∫ncio ‚àí custo ‚Ä¢ lucro final = venda ‚àí custo ‚àí entrega
        </div>
      `;
    }

    function upsert(it){
      const idx = items.findIndex(x=>x.id===it.id);
      if(idx>=0) items[idx]=normalizeItemShape(it); else items.unshift(normalizeItemShape(it));
      aplicarCustoFixoEmTodos();
      save();
      render();
    }

    window.removeItem = function(id){
      items = items.filter(x=>x.id!==id);
      aplicarCustoFixoEmTodos();
      save(); render();
    }

    window.markSold = function(id, sold){
      items = items.map(x=>{
        if(x.id!==id) return x;
        if(sold) return x; // vender √© pelo fluxo (venda r√°pida ou modal)
        return {
          ...x,
          vendido:false,
          valorVenda:0, canalVenda:"", dataVendaISO:"",
          quemVendeu:"", formaEntrega:"", custoEntrega:0,
          pagamentoStatus:"Pendente", pagamentoPrevistoISO:""
        };
      });
      aplicarCustoFixoEmTodos();
      save(); render();
    }

    // ============================
    // ‚úÖ VENDA R√ÅPIDA
    // ============================
    function validateQuickSellPayload(p){
      if(!(p.valorVenda > 0)) return "Preencha o Valor da venda.";
      if(!p.canalVenda) return "Preencha o Canal da venda.";
      if(!p.dataVendaISO) return "Preencha a Data da venda.";
      if(!p.quemVendeu) return "Preencha Quem vendeu.";
      if(!p.formaEntrega) return "Preencha a Forma de entrega.";
      if(p.custoEntrega === null) return "Preencha o Custo entrega (pode ser 0).";
      return null;
    }

    window.openQuickSell = function(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      sellEditingId = id;

      $("sellTitle").textContent = `Venda r√°pida ‚Äî ${it.nomeProduto || "Produto"}`;
      $("sellMeta").textContent = `C√≥digo: ${it.codigo || "‚Äî"} ‚Ä¢ Local: ${it.localEstoque || "‚Äî"} ‚Ä¢ Custo (auto): ${brl(custoUnitarioAtual())}`;

      $("sData").value = nowISO();
      $("sPagStatus").value = "Pendente";
      $("sellHint").style.display = "none";

      openSellModal();
      setTimeout(() => $("sVenda").focus(), 60);
    }

    function applyQuickSell(){
      const it = items.find(x=>x.id===sellEditingId);
      if(!it) return;

      const payload = {
        valorVenda: parseMoney($("sVenda").value),
        canalVenda: ($("sCanal").value || "").trim(),
        dataVendaISO: ($("sData").value || "").trim(),
        quemVendeu: ($("sVendedor").value || "").trim(),
        formaEntrega: ($("sEntrega").value || "").trim(),
        custoEntrega: (() => {
          const raw = ($("sCustoEntrega").value || "").trim();
          if(raw === "") return null;
          return parseMoney(raw);
        })(),
        pagamentoStatus: ($("sPagStatus").value || "Pendente"),
        pagamentoPrevistoISO: ($("sPagPrev").value || "").trim(),
        obsExtra: ($("sObs").value || "")
      };

      const err = validateQuickSellPayload(payload);
      if(err){
        $("sellHint").style.display = "block";
        alert(err);
        return;
      }

      items = items.map(x=>{
        if(x.id !== sellEditingId) return x;

        const baseObs = String(x.observacoes || "").trim();
        const extra = String(payload.obsExtra || "").trim();
        const mergedObs = extra ? (baseObs ? (baseObs + "\n\n" + extra) : extra) : baseObs;

        return {
          ...x,
          vendido: true,
          valorVenda: payload.valorVenda,
          canalVenda: payload.canalVenda,
          dataVendaISO: payload.dataVendaISO,
          quemVendeu: payload.quemVendeu,
          formaEntrega: payload.formaEntrega,
          custoEntrega: payload.custoEntrega,
          pagamentoStatus: payload.pagamentoStatus,
          pagamentoPrevistoISO: payload.pagamentoPrevistoISO,
          observacoes: mergedObs
        };
      });

      aplicarCustoFixoEmTodos();
      save();
      closeSellModal();
      setTab("vendas");
      render();
    }

    // ===== Export/Import =====
    function exportJSON(){
      const blob = new Blob([JSON.stringify(items,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "renova-lotes-backup-" + new Date().toISOString().slice(0,10) + ".json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function toCSVRow(arr){
      return arr.map(v=>{
        const s = String(v ?? "");
        const escaped = s.replaceAll('"','""');
        return `"${escaped}"`;
      }).join(",");
    }
    function exportCSV(){
      const header = [
        "id","codigo","nomeProduto","localEstoque","custoProduto","valorAnuncio","canalAnuncio","dataAnuncioISO",
        "vendido","valorVenda","canalVenda","dataVendaISO","quemVendeu","formaEntrega","custoEntrega",
        "pagamentoStatus","pagamentoPrevistoISO","observacoes","photo1","photo2","photo3"
      ];
      const rows = items.map(i=>[
        i.id, i.codigo, i.nomeProduto, i.localEstoque,
        safe(i.custoProduto), safe(i.valorAnuncio), i.canalAnuncio, i.dataAnuncioISO,
        i.vendido ? "sim" : "nao",
        safe(i.valorVenda), i.canalVenda, i.dataVendaISO, i.quemVendeu, i.formaEntrega, safe(i.custoEntrega),
        i.pagamentoStatus || "",
        i.pagamentoPrevistoISO || "",
        (i.observacoes || "").replaceAll("\n"," "),
        i.photos?.[0] ? "[base64]" : "",
        i.photos?.[1] ? "[base64]" : "",
        i.photos?.[2] ? "[base64]" : ""
      ]);
      const csv = [toCSVRow(header), ...rows.map(toCSVRow)].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "renova-lotes-" + new Date().toISOString().slice(0,10) + ".csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function importJSON(file){
      if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          const parsed = JSON.parse(String(r.result||""));
          if(Array.isArray(parsed)){
            items = parsed.map(normalizeItemShape);
            aplicarCustoFixoEmTodos();
            save(); render();
          } else {
            alert("JSON inv√°lido: precisa ser uma lista (array) de itens.");
          }
        }catch(e){
          alert("Falha ao importar JSON.");
        }
      };
      r.readAsText(file);
    }

    // ============================
    // ‚úÖ BACKUP AUTOM√ÅTICO (SNAPSHOT)
    // ============================
    function getSnapshots(){
      try{
        const raw = localStorage.getItem(SNAP_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      }catch(e){
        return [];
      }
    }
    function saveSnapshots(list){
      localStorage.setItem(SNAP_KEY, JSON.stringify(list));
    }
    function createSnapshot(){
      const snaps = getSnapshots();
      snaps.unshift({
        ts: new Date().toISOString(),
        items: items
      });
      // limita a 10 snapshots
      while(snaps.length > 10) snaps.pop();
      saveSnapshots(snaps);
      alert("Ponto de restaura√ß√£o criado com sucesso.");
    }
    function restoreLastSnapshot(){
      const snaps = getSnapshots();
      if(!snaps.length){
        alert("Nenhum ponto de restaura√ß√£o encontrado.");
        return;
      }
      const s = snaps[0];
      if(confirm("Restaurar o √∫ltimo ponto de restaura√ß√£o? Isso sobrescreve o estado atual.")){
        items = (s.items || []).map(normalizeItemShape);
        aplicarCustoFixoEmTodos();
        save();
        render();
        alert("Restaurado com sucesso.");
      }
    }
    function clearAll(){
      if(confirm("Tem certeza que deseja LIMPAR toda a base? (Recomendado criar um ponto de restaura√ß√£o antes)")){
        items = [];
        aplicarCustoFixoEmTodos();
        save();
        render();
      }
    }

    // ===== FOTOS (3) =====
    function openPhotoModal(){ $("photoBackdrop").style.display = "grid"; }
    function closePhotoModal(){
      $("photoBackdrop").style.display = "none";
      $("photoFile").value = "";
      photoEditingId = null;
      activePhotoSlot = 0;
    }

    function renderPhotoGrid(it){
      const grid = $("photoGrid");
      grid.innerHTML = "";
      const photos = it.photos || ["","",""];

      for(let idx=0; idx<3; idx++){
        const slot = document.createElement("div");
        slot.className = "photo-slot" + (idx===activePhotoSlot ? " active" : "");
        slot.onclick = () => { activePhotoSlot = idx; renderPhotoGrid(it); };

        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = `Foto ${idx+1}`;

        slot.appendChild(badge);

        if(photos[idx]){
          const img = document.createElement("img");
          img.src = photos[idx];
          img.alt = `Foto ${idx+1}`;
          slot.appendChild(img);
        } else {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "Sem foto";
          slot.appendChild(empty);
        }

        grid.appendChild(slot);
      }
    }

    window.openPhoto = function(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      photoEditingId = id;
      activePhotoSlot = 0;

      $("photoTitle").textContent = `Fotos ‚Äî ${it.nomeProduto || "Produto"}`;
      $("photoMetaLine").textContent = `C√≥digo: ${it.codigo || "‚Äî"} ‚Ä¢ Local: ${it.localEstoque || "‚Äî"}`;

      renderPhotoGrid(it);
      openPhotoModal();
    }

    function setPhotoAtSlot(id, slotIndex, dataUrl){
      items = items.map(x=>{
        if(x.id!==id) return x;
        const photos = Array.isArray(x.photos) ? x.photos.slice(0,3) : ["","",""];
        while(photos.length<3) photos.push("");
        photos[slotIndex] = dataUrl;
        return { ...x, photos };
      });
      save(); render();
    }

    function removePhotoAtSlot(id, slotIndex){
      items = items.map(x=>{
        if(x.id!==id) return x;
        const photos = Array.isArray(x.photos) ? x.photos.slice(0,3) : ["","",""];
        while(photos.length<3) photos.push("");
        photos[slotIndex] = "";
        return { ...x, photos };
      });
      save(); render();
    }

    // ===== GR√ÅFICOS (Canvas) =====
    function getSoldItems(){
      return items.filter(i=>i.vendido && safe(i.valorVenda)>0 && i.dataVendaISO);
    }

    function salesSeriesLast30(){
      const sold = getSoldItems();
      const mapCount = new Map();
      const mapRevenue = new Map();
      sold.forEach(i=>{
        mapCount.set(i.dataVendaISO, (mapCount.get(i.dataVendaISO)||0) + 1);
        mapRevenue.set(i.dataVendaISO, (mapRevenue.get(i.dataVendaISO)||0) + safe(i.valorVenda));
      });

      const n=30;
      const labels = [];
      const counts = [];
      const revenue = [];
      const today = new Date(nowISO()+"T00:00:00");
      for(let i=n-1;i>=0;i--){
        const d = new Date(today);
        d.setDate(d.getDate()-i);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        const iso = `${yyyy}-${mm}-${dd}`;
        labels.push(`${dd}/${mm}`);
        counts.push(mapCount.get(iso)||0);
        revenue.push(mapRevenue.get(iso)||0);
      }
      return { labels, counts, revenue };
    }

    function groupBy(list, keyFn, valFn){
      const m = new Map();
      list.forEach(x=>{
        const k = keyFn(x) || "‚Äî";
        const v = valFn(x);
        m.set(k, (m.get(k)||0) + v);
      });
      return m;
    }

    function stockAgingBuckets(){
      const today = new Date(nowISO()+"T00:00:00").getTime();
      const stock = items.filter(i=>!i.vendido && i.dataAnuncioISO);
      const buckets = { "0‚Äì6d":0, "7‚Äì14d":0, "15‚Äì30d":0, "30+d":0 };
      stock.forEach(i=>{
        const t = dateValue(i.dataAnuncioISO);
        if(!t) return;
        const days = Math.round((today - t)/(1000*60*60*24));
        if(days <= 6) buckets["0‚Äì6d"]++;
        else if(days <= 14) buckets["7‚Äì14d"]++;
        else if(days <= 30) buckets["15‚Äì30d"]++;
        else buckets["30+d"]++;
      });
      return buckets;
    }

    function clearCanvas(ctx, w, h){
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "rgba(0,0,0,.0)";
      ctx.fillRect(0,0,w,h);
    }

    function drawAxes(ctx, w, h, pad){
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, h-pad);
      ctx.lineTo(w-pad, h-pad);
      ctx.stroke();
    }

    function drawLineChart(canvasId, labels, values){
      const c = $(canvasId);
      if(!c) return;
      const ctx = c.getContext("2d");
      const w = c.width, h = c.height;
      const pad = 36;

      clearCanvas(ctx,w,h);
      drawAxes(ctx,w,h,pad);

      const max = Math.max(1, ...values);
      const min = Math.min(0, ...values);

      const xStep = (w - pad*2) / Math.max(1, (values.length-1));
      const yScale = (h - pad*2) / (max - min || 1);

      ctx.strokeStyle = "rgba(140,160,255,.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((v,i)=>{
        const x = pad + i*xStep;
        const y = (h-pad) - (v - min)*yScale;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.75)";
      values.forEach((v,i)=>{
        const x = pad + i*xStep;
        const y = (h-pad) - (v - min)*yScale;
        ctx.beginPath();
        ctx.arc(x,y,2.2,0,Math.PI*2);
        ctx.fill();
      });

      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "11px ui-sans-serif, system-ui";
      for(let i=0;i<labels.length;i+=5){
        const x = pad + i*xStep;
        ctx.fillText(labels[i], x-12, h-12);
      }

      ctx.fillStyle = "rgba(255,255,255,.60)";
      ctx.fillText(String(Math.round(max*100)/100), 6, pad+4);
      ctx.fillText(String(Math.round(min*100)/100), 6, h-pad);
    }

    function drawBarChart(canvasId, labels, values){
      const c = $(canvasId);
      if(!c) return;
      const ctx = c.getContext("2d");
      const w = c.width, h = c.height;
      const pad = 36;

      clearCanvas(ctx,w,h);
      drawAxes(ctx,w,h,pad);

      const max = Math.max(1, ...values);
      const barW = (w - pad*2) / Math.max(1, labels.length);

      for(let i=0;i<labels.length;i++){
        const v = values[i];
        const x = pad + i*barW + 6;
        const bh = (h - pad*2) * (v / max);
        const y = (h - pad) - bh;

        ctx.fillStyle = "rgba(90,255,170,.35)";
        ctx.fillRect(x, y, Math.max(6, barW-12), bh);
      }

      ctx.fillStyle = "rgba(255,255,255,.55)";
      ctx.font = "11px ui-sans-serif, system-ui";
      labels.forEach((lab,i)=>{
        const x = pad + i*barW + 6;
        if(labels.length <= 8){
          ctx.fillText(lab, x, h-12);
        } else if(i % 2 === 0){
          ctx.fillText(lab, x, h-12);
        }
      });

      ctx.fillStyle = "rgba(255,255,255,.60)";
      ctx.fillText(String(Math.round(max*100)/100), 6, pad+4);
      ctx.fillText("0", 10, h-pad);
    }

    function renderCharts(){
      const sold = getSoldItems();
      const { labels, counts, revenue } = salesSeriesLast30();

      drawLineChart("cSales30", labels, counts);
      drawLineChart("cRevenue30", labels, revenue);

      const salesByChannel = groupBy(sold, x=>x.canalVenda||"‚Äî", _=>1);
      const channels1 = [...salesByChannel.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
      drawBarChart("cSalesByChannel", channels1.map(x=>x[0]), channels1.map(x=>x[1]));

      const profitByChannel = groupBy(sold, x=>x.canalVenda||"‚Äî", x=> safe(x.valorVenda) - safe(x.custoProduto) - safe(x.custoEntrega));
      const channels2 = [...profitByChannel.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
      drawBarChart("cProfitByChannel", channels2.map(x=>x[0]), channels2.map(x=>Math.round(x[1]*100)/100));

      const aging = stockAgingBuckets();
      drawBarChart("cStockAging", Object.keys(aging), Object.values(aging));
    }

    function render(){
      const filtered = getFiltered();
      const m = compute();

      if(!$("visao").classList.contains("hidden")){
        renderKPIs(m);
        renderQuick(m);
      }

      renderTables(filtered);

      if(!$("graficos").classList.contains("hidden")){
        renderCharts();
      }
    }

    // ===== eventos =====
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    $("homeLogo").addEventListener("click", ()=> setTab("visao"));

    $("q").addEventListener("input", render);

    $("fltAll").addEventListener("click", ()=>{
      filterState.mode = "all";
      setChipActive();
      render();
    });
    $("fltStock").addEventListener("click", ()=>{
      filterState.mode = "stock";
      setChipActive();
      render();
    });
    $("fltSold").addEventListener("click", ()=>{
      filterState.mode = "sold";
      setChipActive();
      render();
    });

    $("newBtn").addEventListener("click", openCreate);

    $("nextCodeBtn").addEventListener("click", ()=>{
      if(editingId) return;
      setNextCodigoIntoField();
    });

    $("exportBtn").addEventListener("click", exportJSON);
    $("exportCsvBtn").addEventListener("click", exportCSV);
    $("importFile").addEventListener("change", (e)=> importJSON(e.target.files?.[0]));

    $("snapshotBtn").addEventListener("click", createSnapshot);
    $("restoreBtn").addEventListener("click", restoreLastSnapshot);
    $("clearBtn").addEventListener("click", clearAll);

    document.addEventListener("click", (e)=>{
      const th = e.target.closest("th.sortable");
      if(!th) return;
      const table = th.dataset.table;
      const key = th.dataset.sortKey;
      const type = th.dataset.sortType;

      const st = sortState[table];
      if(st.key === key){
        st.dir = st.dir === "asc" ? "desc" : "asc";
      } else {
        st.key = key;
        st.type = type;
        st.dir = (type === "date") ? "desc" : "asc";
      }
      render();
    });

    $("closeModal").addEventListener("click", closeModal);
    $("cancelBtn").addEventListener("click", closeModal);

    $("fVendido").addEventListener("change", ()=>{
      const isSold = $("fVendido").value === "sim";
      toggleSalesBlock(isSold);
      if(!isSold){
        clearSaleFields();
        $("requiredHint").style.display = "none";
      } else {
        if(!$("fDataVenda").value) $("fDataVenda").value = nowISO();
        if(!$("fPagStatus").value) $("fPagStatus").value = "Pendente";
      }
      updateCalcPreview();
    });

    $("saveBtn").addEventListener("click", () => {
      const it = readForm();
      const errP = validateProduct(it);
      if(errP){ alert(errP); return; }

      const errS = validateSaleIfNeeded(it);
      if(errS){
        $("requiredHint").style.display = "block";
        alert(errS);
        return;
      }

      $("requiredHint").style.display = "none";
      upsert(it);
      closeModal();
    });

    $("deleteBtn").addEventListener("click", () => {
      if(!editingId) return;
      if(confirm("Excluir este item?")){
        window.removeItem(editingId);
        closeModal();
      }
    });

    ["fAnuncio","fVenda","fCustoEntrega","fDataAnuncio","fDataVenda"].forEach(id=>{
      $(id).addEventListener("input", updateCalcPreview);
      $(id).addEventListener("change", updateCalcPreview);
    });

    $("backdrop").addEventListener("click", (e)=>{
      if(e.target === $("backdrop")) closeModal();
    });

    // venda r√°pida
    $("closeSell").addEventListener("click", closeSellModal);
    $("cancelSell").addEventListener("click", closeSellModal);
    $("confirmSell").addEventListener("click", applyQuickSell);
    $("sellBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("sellBackdrop")) closeSellModal();
    });

    // fotos
    $("closePhoto").addEventListener("click", closePhotoModal);
    $("closePhoto2").addEventListener("click", closePhotoModal);
    $("photoBackdrop").addEventListener("click", (e)=>{
      if(e.target === $("photoBackdrop")) closePhotoModal();
    });

    $("photoFile").addEventListener("change", (e)=>{
      const file = e.target.files?.[0];
      if(!file || !photoEditingId) return;

      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = String(reader.result || "");
        setPhotoAtSlot(photoEditingId, activePhotoSlot, dataUrl);
        const it = items.find(x=>x.id===photoEditingId);
        if(it) renderPhotoGrid(it);
      };
      reader.readAsDataURL(file);
    });

    $("removeSelectedPhotoBtn").addEventListener("click", ()=>{
      if(!photoEditingId) return;
      removePhotoAtSlot(photoEditingId, activePhotoSlot);
      const it = items.find(x=>x.id===photoEditingId);
      if(it) renderPhotoGrid(it);
    });

    // selects
    fillSelect("fCanalAnuncio", CANAIS);
    fillSelect("fCanalVenda", CANAIS, true);
    fillSelect("fVendedor", VENDEDORES, true);
    fillSelect("fEntrega", ENTREGAS, true);
    fillSelect("fPagStatus", PAG_STATUS);

    fillSelect("sCanal", CANAIS, true);
    fillSelect("sVendedor", VENDEDORES, true);
    fillSelect("sEntrega", ENTREGAS, true);
    fillSelect("sPagStatus", PAG_STATUS);

    load();
    setChipActive();
    updateCalcPreview();
    render();
  </script>
</body>
</html>

